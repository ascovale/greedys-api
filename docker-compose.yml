version: '3.8'

services:
  # ===== TRAEFIK (Reverse Proxy + SSL/TLS con Let's Encrypt) =====
  traefik:
    image: traefik:v3.0
    restart: always
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager  # Traefik sempre su manager
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    networks:
      - app-network
    ports:
      - "80:80"      # HTTP (redirect a HTTPS)
      - "443:443"    # HTTPS (Let's Encrypt)
    environment:
      - TRAEFIK_API_DASHBOARD=true
      - TRAEFIK_API_DEBUG=false
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_EMAIL=beeinggreedy@gmail.com
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_STORAGE=/acme.json
      - TRAEFIK_CERTIFICATESRESOLVERS_LETSENCRYPT_ACME_HTTPCHALLENGE_ENTRYPOINT=web
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./traefik/traefik.yml:/traefik.yml:ro
      - ./traefik/dynamic.yml:/dynamic.yml:ro
      - ./traefik/acme.json:/acme.json
    labels:
      # Dashboard Traefik (disabilitato - usa file provider)
      - "traefik.enable=true"

  # ===== SPRING BOOT API =====
  spring-app:
    image: registry.gitlab.com/greedysgroup/greedys_api:latest
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    depends_on:
      - db
      - rabbitmq
    networks:
      - app-network
    ports:
      - "8080:8080"  # HTTP diretto (interno, no HTTPS)
    environment:
      SPRING_PROFILES_ACTIVE: "docker"
      SERVER_PORT: 8080
      SERVER_SSL_ENABLED: "false"  # NO HTTPS interno (Traefik gestisce)
      # RabbitMQ Configuration
      SPRING_RABBITMQ_HOST: rabbitmq
      SPRING_RABBITMQ_PORT: 5672
      SPRING_RABBITMQ_USERNAME_FILE: /run/secrets/rabbitmq_user
      SPRING_RABBITMQ_PASSWORD_FILE: /run/secrets/rabbitmq_password
      SPRING_RABBITMQ_VIRTUAL_HOST: /greedys
      # Notification Outbox Poller Configuration
      NOTIFICATION_OUTBOX_MULTI_POLLER_ENABLED: "false"
      NOTIFICATION_OUTBOX_FAST_POLLER_DELAY_MS: "1000"
      NOTIFICATION_OUTBOX_FAST_POLLER_FRESH_EVENT_WINDOW_SECONDS: "60"
      NOTIFICATION_OUTBOX_SLOW_POLLER_DELAY_MS: "30000"
      NOTIFICATION_OUTBOX_SLOW_POLLER_STUCK_EVENT_THRESHOLD_SECONDS: "60"
    secrets:
      - db_password
      - email_password
      - service_account
      - jwt_secret
      - rabbitmq_user
      - rabbitmq_password
    labels:
      # API Router con HTTPS
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.greedys.it`)"
      - "traefik.http.routers.api.entrypoints=web,websecure"
      - "traefik.http.routers.api.service=api"
      - "traefik.http.routers.api.tls.certresolver=letsencrypt"
      - "traefik.http.services.api.loadbalancer.server.port=8080"

  # ===== FLUTTER APP (Nginx) =====
  flutter-app:
    image: nginx:latest
    deploy:
      replicas: 1
      update_config:
        parallelism: 1
        delay: 5s
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    networks:
      - app-network
    # NO ports exposed - Traefik far√† il routing interno
    volumes:
      - /home/deployer/restaurant-app:/usr/share/nginx/html/restaurant:ro
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    labels:
      # Flutter App Router con HTTPS
      - "traefik.enable=true"
      - "traefik.http.routers.flutter-app.rule=Host(`app.greedys.it`)"
      - "traefik.http.routers.flutter-app.entrypoints=web,websecure"
      - "traefik.http.routers.flutter-app.service=flutter-app"
      - "traefik.http.routers.flutter-app.tls.certresolver=letsencrypt"
      - "traefik.http.services.flutter-app.loadbalancer.server.port=80"

  # ===== MySQL DATABASE =====
  db:
    image: mysql:8.0
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager  # Database sempre su manager per persistenza
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    networks:
      - app-network
    ports:
      - "3309:3306"
    environment:
      MYSQL_DATABASE: greedys_v1
      MYSQL_ROOT_PASSWORD_FILE: /run/secrets/db_password
      MYSQL_INITDB_SKIP_TZINFO: "yes"
    volumes:
      - db_data:/var/lib/mysql
    secrets:
      - db_password
    healthcheck:
      test: ["CMD-SHELL", "mysqladmin ping -h localhost -uroot -p\"$$(cat /run/secrets/db_password)\" || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5

  # ===== RABBITMQ MESSAGE BROKER =====
  rabbitmq:
    image: rabbitmq:3.13-management-alpine
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.role == manager  # RabbitMQ su manager per persistenza
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
    networks:
      - app-network
    ports:
      - "5672:5672"    # AMQP protocol
      - "15672:15672"  # Management UI
    environment:
      # RabbitMQ 3.13 non supporta _FILE variables - usa config file
      RABBITMQ_PLUGINS: "rabbitmq_management,rabbitmq_consistent_hash_exchange,rabbitmq_priority_queue"
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
      - ./rabbitmq/rabbitmq.conf:/etc/rabbitmq/rabbitmq.conf:ro
      - ./rabbitmq/init-rabbitmq.sh:/docker-entrypoint-initdb.d/init-rabbitmq.sh:ro
    secrets:
      - rabbitmq_user
      - rabbitmq_password
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
    labels:
      # RabbitMQ Management UI con HTTPS
      - "traefik.enable=true"
      - "traefik.http.routers.rabbitmq.rule=Host(`rabbitmq.greedys.it`)"
      - "traefik.http.routers.rabbitmq.entrypoints=web,websecure"
      - "traefik.http.routers.rabbitmq.service=rabbitmq"
      - "traefik.http.routers.rabbitmq.tls.certresolver=letsencrypt"
      - "traefik.http.services.rabbitmq.loadbalancer.server.port=15672"
      # Basic Auth per Management UI
      - "traefik.http.routers.rabbitmq.middlewares=rabbitmq-auth"
      - "traefik.http.middlewares.rabbitmq-auth.basicauth.users=admin:$$2y$$10$$yourhashpassword"  # CAMBIA PASSWORD!

networks:
  app-network:
    driver: overlay
    attachable: true

volumes:
  db_data:
  rabbitmq_data:

secrets:
  db_password:
    external: true
  email_password:
    external: true
  service_account:
    external: true
  jwt_secret:
    external: true
  rabbitmq_user:
    external: true
  rabbitmq_password:
    external: true

