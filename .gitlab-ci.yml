# Pipeline fix: risolto problema database connectivity - cleaned volumes
variables:
  TAG_LATEST: ${CI_REGISTRY_IMAGE}:latest
  TAG_COMMIT: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
  DART_REPO: https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
  # Base URL delle spec OpenAPI - HTTP porta 8080 (configurazione Docker)
  API_DOCS_BASE: "http://api.greedys.it:8080/v3/api-docs"
  # ðŸ†• Base URL per response wrappers catalog - HTTP porta 8080
  WRAPPERS_ENDPOINT: "http://api.greedys.it:8080/api/internal/response-wrapper-catalog"
  # Elenco dei gruppi da processare
  API_GROUPS: "restaurant admin customer"
  # ðŸ†• OpenAPI Generator CLI version per download diretto se necessario
  OPENAPI_GENERATOR_VERSION: "7.8.0"
  # ðŸ†• URL per scaricare gli artefatti del custom generator
  GENERATOR_ARTIFACTS_URL: "https://gitlab.com/greedysgroup/greedys_generator/-/jobs/artifacts/main/download?job=build"

stages:
  - build
  - deploy
  - publish

cache:
  paths:
    - .m2/repository
    - node_modules/
    - tools/  # ðŸ†• Cache per JAR e tools scaricati

build:
  image: docker:24.0.5
  stage: build
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_BUILDKIT: "1"
  script:
    - echo "Logging into Docker registry..."
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
    - echo "Building and tagging Docker image..."
    - |
      for i in 1 2 3; do \
        docker build --pull --progress=plain -t $TAG_LATEST --build-arg SPRING_PROFILES_ACTIVE="docker" . && break || { echo "docker build failed (attempt $i/3), retrying in 10s"; sleep 10; }; \
      done
    - echo "Tagging Docker image with commit tag..."
    - docker tag $TAG_LATEST $TAG_COMMIT
    - echo "Pushing Docker images..."
    - docker push $TAG_LATEST
    - docker push $TAG_COMMIT
  only:
    - main
  after_script:
    - echo "Cleaning up Docker resources..."
    - docker system prune -f

deploy:
  image: alpine:3.18
  stage: deploy
  before_script:
    - apk add --no-cache openssh-client openssh-keygen
    # Crea cartella deploy per organizzare i file temporanei
    - mkdir -p deploy
    # se $ID_RSA Ã¨ una variabile **File**:
    - cp "$ID_RSA" deploy/id_key
    - tr -d '\r' < deploy/id_key > deploy/id_key.clean && mv deploy/id_key.clean deploy/id_key
    - chmod 600 deploy/id_key
    - mkdir -p ~/.ssh && ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
    # sanity: tipo e fingerprint
    - echo "== Key sanity ==" && head -1 deploy/id_key && tail -1 deploy/id_key
    - ssh-keygen -lf deploy/id_key
    # confronta con la chiave pubblica che hai messo su deployer
    - ssh-keygen -y -f deploy/id_key > deploy/id_key.pub
    - |
      echo "== Match con authorized_keys su deployer =="
      ssh -o BatchMode=yes -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" \
        "grep -F -x -q \"$(cat deploy/id_key.pub)\" ~/.ssh/authorized_keys && echo MATCH || echo NO_MATCH"
  script:
    - ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'mkdir -p ~/greedys_api/'
    - scp -o IdentitiesOnly=yes -i deploy/id_key docker-compose.yml deploy.sh deployer@"$SERVER_IP":~/greedys_api/
    - printf '%s' "$CI_JOB_TOKEN" | ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" "docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY"
    - ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'cd ~/greedys_api/ && chmod +x ./deploy.sh && ./deploy.sh'
  only: [main]


publish:
  stage: publish
  before_script:
    - echo "Setup ambiente per generazione Dart..."
    # Installa solo le dipendenze essenziali
    - apt-get update && apt-get install -y curl git maven
    
    # Installa OpenAPI Generator CLI
    - curl -sL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - npm install -g @openapitools/openapi-generator-cli

    # SCARICA GLI ARTEFATTI DEL CUSTOM GENERATOR
    - echo "ðŸ“¦ Scarico gli artefatti del custom generator..."
    - curl -sL --header "PRIVATE-TOKEN:$PAT" "$GENERATOR_ARTIFACTS_URL" -o generator-artifacts.zip
    - unzip -q generator-artifacts.zip
    - ls -la generator/
    - echo "âœ… Artefatti custom generator scaricati"

    # Setup GIT con PAT (metodo unificato)
    - echo "echo \$PAT" > /tmp/git-askpass.sh
    - chmod +x /tmp/git-askpass.sh
    - export GIT_ASKPASS=/tmp/git-askpass.sh

    - echo "Clono il repo delle librerie Dart (greedys_api_dart_lib)â€¦"
    - git clone https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
    - cd greedys_api_dart_lib
    - git config user.email "ci-bot@greedys.com"
    - git config user.name  "Greedys CI Bot"
    
    # Ricrea i JAR necessari nella directory corrente
    - echo "ðŸ“¦ Setup JAR per generazione nella directory dart_lib..."
    - mkdir -p tools
    - curl -sL "https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/7.8.0/openapi-generator-cli-7.8.0.jar" -o "tools/openapi-generator-cli.jar"
    - cp "generator/target/custom-dart-codegen-latest.jar" "tools/" || echo "âŒ Custom JAR non trovato"
    - ls -la tools/
    
    # Configura variabili per la generazione
    - export NPM_OPENAPI_JAR="tools/openapi-generator-cli.jar"
    - export CUSTOM_JAR="tools/custom-dart-codegen-latest.jar"
    - echo "JAR configurati localmente:"
    - echo "OpenAPI JAR:" "$NPM_OPENAPI_JAR"
    - echo "Custom JAR:" "$CUSTOM_JAR"

  script:
    - echo "â³ Attendo che l'API sia pronta dopo il deploy..."
    - echo "Controllo endpoint:" "${API_DOCS_BASE}/restaurant-api"
    
    # Delay iniziale per permettere al deployment di completarsi
    - echo "ðŸ• Attendo 2 minuti per il deployment..."
    - sleep 120
    
    - |
      for i in {1..30}; do
        echo "Tentativo $i/30: Testing ${API_DOCS_BASE}/restaurant-api"
        
        # Test piÃ¹ dettagliato con output degli errori
        echo "ðŸ” Test endpoint base..."
        if curl -f --max-time 10 --connect-timeout 5 "http://api.greedys.it:8080" >/dev/null 2>&1; then
          echo "âœ… Server base risponde"
          
          # Test health check se disponibile
          echo "ðŸ” Test health check..."
          curl -f --max-time 5 "http://api.greedys.it:8080/actuator/health" && echo "âœ… Health OK" || echo "âŒ Health check non disponibile"
          
          # Test OpenAPI docs
          echo "ðŸ” Test OpenAPI docs..."
          if curl -f --max-time 15 --connect-timeout 10 "${API_DOCS_BASE}/restaurant-api" >/dev/null 2>&1; then
            echo "âœ… API docs pronte! Procedo con la generazione client..."
            break
          else
            echo "âŒ OpenAPI docs non disponibili"
            # Mostra cosa restituisce l'endpoint
            echo "Contenuto dell'endpoint:"
            curl --max-time 5 "${API_DOCS_BASE}/restaurant-api" 2>/dev/null | head -10 || echo "Nessuna risposta"
          fi
        else
          echo "âŒ Server base non risponde"
          # Verifica i logs del container
          echo "ðŸ“‹ Ultimi logs del servizio:"
          docker service logs --tail 20 greedys_greedys-api 2>/dev/null | tail -5 || echo "âŒ Impossibile recuperare logs"
        fi
        
        sleep 10
        if [ $i -eq 30 ]; then
          echo "âŒ TIMEOUT: API non risponde dopo 7+ minuti totali"
          echo "Provo ultimo test di connettivitÃ ..."
          curl -I --max-time 5 "http://api.greedys.it:8080" || echo "Server completamente irraggiungibile"
          exit 1
        fi
      done
    
    - echo "Pulisco cartelle client APIâ€¦"
    - rm -rf restaurant admin customer

    # GENERA PER OGNI GRUPPO con CUSTOM GENERATOR
    - |
      for GROUP in $API_GROUPS; do
        SPEC_FILE="./openapi-${GROUP}.json"
        OUTPUT_DIR="./${GROUP}_api"

        echo
        echo ">>> Generazione client per $GROUP <<<"
        echo "- Scarico spec da $API_DOCS_BASE/${GROUP}-api"
        
        # Debug: verifica cosa ritorna l'endpoint
        echo "Debug: test connessione endpoint..."
        curl -Ik "${API_DOCS_BASE}/${GROUP}-api" || echo "âŒ Endpoint non raggiungibile"
        
        # Scarica con piÃ¹ debug
        echo "Scarico spec..."
        if curl -sSfk -o "$SPEC_FILE" "${API_DOCS_BASE}/${GROUP}-api"; then
          echo "âœ… Spec scaricata, dimensione: $(wc -c < "$SPEC_FILE") bytes"
          echo "Prime righe del file spec:"
          head -n 5 "$SPEC_FILE"
        else
          echo "âŒ ERRORE: Impossibile scaricare spec da ${API_DOCS_BASE}/${GROUP}-api"
          echo "Verifica manuale dell'endpoint:"
          curl -v "${API_DOCS_BASE}/${GROUP}-api" 2>&1 | head -20
          exit 1
        fi

        # SCARICA RESPONSE WRAPPERS SPECIFICO PER GRUPPO
        echo "- Scarico catalogo response wrappers per gruppo $GROUP..."
        curl -sSfk -o "generator/response-wrappers-${GROUP}.json" "$WRAPPERS_ENDPOINT/${GROUP}" || echo "âš ï¸ Catalogo wrappers per $GROUP non disponibile"

        # GENERA CON CUSTOM GENERATOR
        echo "- ðŸŽ¯ Genero con CUSTOM generator in $OUTPUT_DIR"
        ls -la "$NPM_OPENAPI_JAR" "$CUSTOM_JAR"
        
        java -cp "$NPM_OPENAPI_JAR:$CUSTOM_JAR" org.openapitools.codegen.OpenAPIGenerator generate \
          -g org.openapitools.custom.CustomDartClientCodegen \
          -i "$SPEC_FILE" \
          -o "$OUTPUT_DIR" \
          -t "generator/templates" \
          --ignore-file-override "generator/.openapi-generator-ignore" \
          --skip-validate-spec \
          -p pubName=${GROUP}_api \
          #RENAMED: Added -api suffix for better organization (restaurant-api, admin-api, customer-api)
          -p pubVersion=1.0.0 \
          -p pubDescription="Greedys ${GROUP^} API client" \
          -p pubHomepage=https://greedys.it

        # POST-PROCESSING
        echo "- Post-processing per $GROUP..."
        
        # Rimuovi doc ResponseWrapper indesiderati
        [ -d "$OUTPUT_DIR/doc" ] && find "$OUTPUT_DIR/doc" -name "ResponseWrapper*.md" ! -name "ResponseWrapperErrorDetails.md" -delete 2>/dev/null || true
        
        # Rimuovi test ResponseWrapper indesiderati  
        [ -d "$OUTPUT_DIR/test" ] && find "$OUTPUT_DIR/test" -name "response_wrapper*.dart" ! -name "response_wrapper_error_details_test.dart" -delete 2>/dev/null || true
        
        # Pulisci import ResponseWrapper generati automaticamente (escludi quello di common)
        [ -d "$OUTPUT_DIR/lib" ] && find "$OUTPUT_DIR/lib" -name "*.dart" -exec sed -i "/^import 'package:${GROUP}_api\/.*\/response_wrapper.*';$/d" {} \; 2>/dev/null || true
        
        # Aggiorna pubspec.yaml con common
        PUBSPEC="$OUTPUT_DIR/pubspec.yaml"
        if [ -f "$PUBSPEC" ] && ! grep -q "common:" "$PUBSPEC"; then
          echo "  common:" >> "$PUBSPEC"
          echo "    path: ../common" >> "$PUBSPEC"
        fi
        
        # Pulisci export ResponseWrapper da openapi.dart
        OPENAPI_FILE="$OUTPUT_DIR/lib/openapi.dart"
        [ -f "$OPENAPI_FILE" ] && sed -i "/^export 'package:.*\/response_wrapper\([^_]\|_[^e]\)/d" "$OPENAPI_FILE" 2>/dev/null || true

        echo "- Rimuovo spec temporanea"
        rm "$SPEC_FILE"
        
        echo "âœ… Client $GROUP generato (post-processing sarÃ  fatto dalla pipeline dedicata)"
      done

    - echo
    - echo "Committiamo e pushiamo le modificheâ€¦"
    - git add .
    - |
      if git diff-index --quiet HEAD; then
        echo " Nessuna modifica da pushare."
      else
        # COMMIT MESSAGE - client base senza post-processing
        COMMIT_MSG="ðŸ¤– Genera Dart clients base: $API_GROUPS (post-processing in pipeline dedicata)"
        
        git commit -m "$COMMIT_MSG"
        git push origin main
        echo "âœ… Client pushati con successo!"
      fi

  only:
    - main