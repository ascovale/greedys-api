variables:
  TAG_LATEST: ${CI_REGISTRY_IMAGE}:latest
  TAG_COMMIT: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
  DART_REPO: git@gitlab.com:PsychoOrange/greedys_api_dart_lib.git
  # Comando per invocare OpenAPI Generator (installato via npm)
  OPENAPI_CLI: openapi-generator-cli
  # Base URL delle spec (modifica se serve)
  API_DOCS_BASE: "https://api.greedys.it/v3/api-docs"
  # Elenco dei gruppi da processare
  API_GROUPS: "restaurant admin customer"

stages:
  - build
  - deploy
  - publish

cache:
  paths:
    - .m2/repository
    - node_modules/

build:
  image: docker:24.0.5
  stage: build
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_BUILDKIT: "1"
  script:
    - echo "Logging into Docker registry..."
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
    - echo "Building and tagging Docker image..."
    - |
      for i in 1 2 3; do \
        docker build --pull --progress=plain -t $TAG_LATEST --build-arg SPRING_PROFILES_ACTIVE="docker" . && break || { echo "docker build failed (attempt $i/3), retrying in 10s"; sleep 10; }; \
      done
    - echo "Tagging Docker image with commit tag..."
    - docker tag $TAG_LATEST $TAG_COMMIT
    - echo "Pushing Docker images..."
    - docker push $TAG_LATEST
    - docker push $TAG_COMMIT
  only:
    - main
  after_script:
    - echo "Cleaning up Docker resources..."
    - docker system prune -f

deploy:
  image: alpine:3.18
  stage: deploy
  before_script:
    - apk add --no-cache openssh-client openssh-keygen
    # se $ID_RSA è una variabile **File**:
    - cp "$ID_RSA" id_key
    - tr -d '\r' < id_key > id_key.clean && mv id_key.clean id_key
    - chmod 600 id_key
    - mkdir -p ~/.ssh && ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
    # sanity: tipo e fingerprint
    - echo "== Key sanity ==" && head -1 id_key && tail -1 id_key
    - ssh-keygen -lf id_key
    # confronta con la chiave pubblica che hai messo su deployer
    - ssh-keygen -y -f id_key > id_key.pub
    - |
      echo "== Match con authorized_keys su deployer =="
      ssh -o BatchMode=yes -o IdentitiesOnly=yes -i id_key deployer@"$SERVER_IP" \
        "grep -F -x -q \"$(cat id_key.pub)\" ~/.ssh/authorized_keys && echo MATCH || echo NO_MATCH"
  script:
    - ssh -o IdentitiesOnly=yes -i id_key deployer@"$SERVER_IP" 'mkdir -p ~/greedys_api/'
    - scp -o IdentitiesOnly=yes -i id_key docker-compose.yml deploy.sh deployer@"$SERVER_IP":~/greedys_api/
    - printf '%s' "$CI_JOB_TOKEN" | ssh -o IdentitiesOnly=yes -i id_key deployer@"$SERVER_IP" "docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY"
    - ssh -o IdentitiesOnly=yes -i id_key deployer@"$SERVER_IP" 'cd ~/greedys_api/ && chmod +x ./deploy.sh && ./deploy.sh'
  only: [main]


publish:
  image: openjdk:11-jre-slim
  stage: publish
  before_script:
    - echo "Aggiorno apt, installo curl, git e Node.js…"
    - apt-get update && apt-get install -y curl git
    - curl -sL https://deb.nodesource.com/setup_18.x | bash -
    - apt-get install -y nodejs
    - npm install -g @openapitools/openapi-generator-cli

    # Setup GIT con PAT
    - echo "echo \$PAT" > /tmp/git-askpass.sh
    - chmod +x /tmp/git-askpass.sh
    - export GIT_ASKPASS=/tmp/git-askpass.sh

    - echo "Clono il repo del client Dart…"
    - git clone https://gitlab.com/PsychoOrange/greedys_api_dart_lib.git
    - cd greedys_api_dart_lib
    - git config user.email "ci-bot@greedys.com"
    - git config user.name  "Greedys CI Bot"

  script:
    - echo "Pulisco cartelle client…"
    - rm -rf src/restaurant src/admin src/customer

    # Per ogni gruppo: scarica spec e genera client
    - |
      for GROUP in $API_GROUPS; do
        SPEC_FILE="./openapi-${GROUP}.json"
        OUTPUT_DIR="./${GROUP}"

        echo
        echo ">>> Generazione client per $GROUP <<<"
        echo "- Scarico spec da $API_DOCS_BASE/${GROUP}-api"
        curl -sSf -o "$SPEC_FILE" "${API_DOCS_BASE}/${GROUP}-api"

        echo "- Genero Dart client in $OUTPUT_DIR"
        $OPENAPI_CLI generate -i $SPEC_FILE -g dart-dio -o $OUTPUT_DIR

        echo "- Rimuovo spec temporanea"
        rm "$SPEC_FILE"
      done

    - echo
    - echo "Committiamo e pushiamo le modifiche generati…"
    - git add .
    - |
      if git diff-index --quiet HEAD; then
        echo "Nessuna modifica da pushare."
      else
        git commit -m "Aggiorna Dart clients: $API_GROUPS"
        git push origin main
      fi

  only:
    - main