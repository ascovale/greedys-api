# Pipeline corretta per API con generator v1.0.0-SNAPSHOT
variables:
  TAG_LATEST: ${CI_REGISTRY_IMAGE}:latest
  TAG_COMMIT: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
  DART_REPO: https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
  API_DOCS_BASE: "http://api.greedys.it:8080/v3/api-docs"
  WRAPPERS_ENDPOINT: "http://api.greedys.it:8080/api/internal/response-wrapper-catalog"
  API_GROUPS: "restaurant admin customer"

stages:
  - build
  - deploy
  - publish

cache:
  paths:
    - .m2/repository
    - node_modules/
    - tools/

build:
  image: docker:24.0.5
  stage: build
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_BUILDKIT: "1"
  script:
    - echo "Logging into Docker registry..."
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
    - echo "Building and tagging Docker image..."
    - |
      for i in 1 2 3; do \
        docker build --pull --progress=plain -t $TAG_LATEST --build-arg SPRING_PROFILES_ACTIVE="docker" . && break || { echo "docker build failed (attempt $i/3), retrying in 10s"; sleep 10; }; \
      done
    - echo "Tagging Docker image with commit tag..."
    - docker tag $TAG_LATEST $TAG_COMMIT
    - echo "Pushing Docker images..."
    - docker push $TAG_LATEST
    - docker push $TAG_COMMIT
  only:
    - main
  after_script:
    - echo "Cleaning up Docker resources..."
    - docker system prune -f

deploy:
  image: alpine:3.18
  stage: deploy
  before_script:
    - apk add --no-cache openssh-client openssh-keygen
    - mkdir -p deploy
    - cp "$ID_RSA" deploy/id_key
    - tr -d '\r' < deploy/id_key > deploy/id_key.clean && mv deploy/id_key.clean deploy/id_key
    - chmod 600 deploy/id_key
    - mkdir -p ~/.ssh && ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
    - echo "== Key sanity ==" && head -1 deploy/id_key && tail -1 deploy/id_key
    - ssh-keygen -lf deploy/id_key
    - ssh-keygen -y -f deploy/id_key > deploy/id_key.pub
    - |
      echo "== Match con authorized_keys su deployer =="
      ssh -o BatchMode=yes -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" \
        "grep -F -x -q \"$(cat deploy/id_key.pub)\" ~/.ssh/authorized_keys && echo MATCH || echo NO_MATCH"
  script:
    - ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'mkdir -p ~/greedys_api/'
    - scp -o IdentitiesOnly=yes -i deploy/id_key docker-compose.yml deploy.sh deployer@"$SERVER_IP":~/greedys_api/
    - printf '%s' "$CI_JOB_TOKEN" | ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" "docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY"
    - ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'cd ~/greedys_api/ && chmod +x ./deploy.sh && ./deploy.sh'
  only: [main]

publish:
  image: openjdk:17-slim
  stage: publish
  before_script:
    - echo "Setup ambiente per generazione Dart..."
    - apt-get update && apt-get install -y curl git unzip jq
    
    # SCARICA JAR STANDALONE E TEMPLATES DALLA VERSIONE 1.0.0-SNAPSHOT
    - echo "üì¶ Scarico JAR standalone custom e templates dal Package Registry v1.0.0-SNAPSHOT..."
    - mkdir -p tools generator/templates
    - |
      # Ricerca dinamica URL corretto per versione 1.0.0-SNAPSHOT con timestamp
      echo "ÔøΩ Ricerca versione 1.0.0-SNAPSHOT con timestamp corretto..."
      
      # Query Package Registry per trovare l'URL esatto con timestamp
      PACKAGES_JSON=$(curl -s --header "Private-Token:$PAT" \
        "https://gitlab.com/api/v4/projects/greedysgroup%2Fgreedys_generator/packages?package_type=maven")
      
      echo "üìã Packages trovati: $(echo "$PACKAGES_JSON" | jq -r 'length') packages"
      
      # Trova il package org/openapitools/custom/custom-dart-codegen con versione 1.0.0-SNAPSHOT pi√π recente
      SNAPSHOT_PACKAGE_ID=$(echo "$PACKAGES_JSON" | jq -r '.[] | select(.name == "org/openapitools/custom/custom-dart-codegen" and (.version | contains("1.0.0-SNAPSHOT"))) | .id' | head -1)
      
      if [ -z "$SNAPSHOT_PACKAGE_ID" ]; then
        echo "‚ùå ERRORE: Package 1.0.0-SNAPSHOT non trovato"
        echo "üìã Versioni disponibili:"
        echo "$PACKAGES_JSON" | jq -r '.[] | .version' | head -10
        exit 1
      fi
      
      echo "üì¶ Package ID trovato: $SNAPSHOT_PACKAGE_ID"
      
      # Ottieni i file del package
      PACKAGE_FILES=$(curl -s --header "Private-Token:$PAT" \
        "https://gitlab.com/api/v4/projects/greedysgroup%2Fgreedys_generator/packages/$SNAPSHOT_PACKAGE_ID/package_files")
      
      # Trova il JAR standalone (quello pi√π grande, ~31MB) - dinamicamente
      JAR_FILE_ID=$(echo "$PACKAGE_FILES" | jq -r '.[] | select(.file_name | endswith("-standalone.jar")) | select(.size > 30000000) | .id')
      
      if [ -z "$JAR_FILE_ID" ]; then
        echo "‚ùå ERRORE: JAR standalone non trovato"
        echo "üìã Files disponibili:"
        echo "$PACKAGE_FILES" | jq -r '.[] | .file_name + " (" + (.size | tostring) + " bytes)"'
        exit 1
      fi
      
      echo "üîΩ Download JAR standalone (File ID: $JAR_FILE_ID)..."
      curl -s --header "Private-Token:$PAT" "https://gitlab.com/api/v4/projects/greedysgroup%2Fgreedys_generator/packages/$SNAPSHOT_PACKAGE_ID/package_files/$JAR_FILE_ID" -o "tools/custom-generator.jar"
      
      # Controlla dimensione JAR
      echo "üìä JAR scaricato - dimensione: $(stat -c%s tools/custom-generator.jar) bytes"
      if [ $(stat -c%s "tools/custom-generator.jar") -lt 1000000 ]; then
        echo "‚ùå JAR troppo piccolo (dovrebbe essere ~31MB), contenuto errore:"
        cat tools/custom-generator.jar
        
        # üÜï DEBUG DETTAGLIATO DEL JAR
        echo "üîç Analisi dettagliata del JAR:"
        echo "   File type: $(file tools/custom-generator.jar)"
        echo "   Verifica ZIP structure:"
        unzip -l tools/custom-generator.jar | head -10 || echo "‚ùå Struttura JAR non valida"
        echo "   Controllo MANIFEST.MF:"
        unzip -p tools/custom-generator.jar META-INF/MANIFEST.MF | head -10 || echo "‚ùå MANIFEST.MF non trovato"
        echo "   Test esecuzione JAR:"
        java -jar tools/custom-generator.jar --help 2>&1 | head -5 || echo "‚ùå JAR non eseguibile"
        
        exit 1
      else
        echo "‚úÖ JAR standalone dimensione OK ($(stat -c%s tools/custom-generator.jar) bytes)"
      fi
      
      # Trova il templates ZIP usando l'API dinamica
      TEMPLATES_FILE_ID=$(echo "$PACKAGE_FILES" | jq -r '.[] | select(.file_name | endswith("-templates.zip")) | .id')
      
      if [ -z "$TEMPLATES_FILE_ID" ]; then
        echo "‚ùå ERRORE: Templates ZIP non trovato"
        echo "üìã Files disponibili:"
        echo "$PACKAGE_FILES" | jq -r '.[] | .file_name + " (" + (.size | tostring) + " bytes)"'
        exit 1
      fi
      
      echo "üîΩ Download templates ZIP (File ID: $TEMPLATES_FILE_ID)..."
      curl -s --header "Private-Token:$PAT" "https://gitlab.com/api/v4/projects/greedysgroup%2Fgreedys_generator/packages/$SNAPSHOT_PACKAGE_ID/package_files/$TEMPLATES_FILE_ID" -o "templates.zip"
      
      # Controlla dimensione Templates ZIP
      echo "üìä Templates ZIP - dimensione: $(stat -c%s templates.zip) bytes"
      if [ $(stat -c%s "templates.zip") -lt 1000 ]; then
        echo "‚ùå Templates ZIP troppo piccolo, contenuto errore:"
        cat templates.zip
        exit 1
      else
        echo "‚úÖ Templates ZIP dimensione OK ($(stat -c%s templates.zip) bytes)"
      fi
      
      # Estrai templates
      if [ -f "templates.zip" ] && [ -s "templates.zip" ]; then
        unzip -q templates.zip -d generator/templates/
        echo "‚úÖ Templates estratti: $(find generator/templates -name '*.mustache' | wc -l) files"
      else
        echo "‚ùå ERRORE: Templates ZIP non valido"
        exit 1
      fi
      
      # Verifica che il JAR standalone sia eseguibile
      echo "üß™ Verifica JAR standalone eseguibile..."
      
      # Debug: Mostra Main-Class dal MANIFEST.MF
      echo "üîç Main-Class nel MANIFEST.MF:"
      unzip -p "tools/custom-generator.jar" META-INF/MANIFEST.MF | grep "Main-Class" || echo "   Main-Class non trovato"
      
      if java -jar "tools/custom-generator.jar" version >/dev/null 2>&1; then
        echo "‚úÖ JAR standalone funzionante"
      elif java -jar "tools/custom-generator.jar" help >/dev/null 2>&1; then
        echo "‚úÖ JAR standalone funzionante"  
      elif java -jar "tools/custom-generator.jar" list >/dev/null 2>&1; then
        echo "‚úÖ JAR standalone funzionante"
      else
        echo "‚ö†Ô∏è AVVISO: Test esecuzione JAR fallito, procedo comunque..."
        echo "   Output test help:"
        java -jar "tools/custom-generator.jar" help 2>&1 | head -5 || echo "   Comando help fallito"
        echo "   Output test senza parametri:"
        java -jar "tools/custom-generator.jar" 2>&1 | head -5 || echo "   Comando senza parametri fallito"
      fi
      
    # Setup GIT con PAT
    - echo "echo \$PAT" > /tmp/git-askpass.sh
    - chmod +x /tmp/git-askpass.sh
    - export GIT_ASKPASS=/tmp/git-askpass.sh
    - export CUSTOM_JAR="../tools/custom-generator.jar"

    - echo "Clono repo Dart API..."
    - git clone https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
    - cd greedys_api_dart_lib
    - git config user.email "ci-bot@greedys.com"
    - git config user.name "Greedys CI Bot"
    
    # Verifica finale
    - 'echo "JAR configurato: $CUSTOM_JAR ($(stat -c%s \"$CUSTOM_JAR\") bytes)"'

  script:
    - echo "‚è≥ Attendo che l'API sia pronta..."
    - sleep 120
    
    # Test connessione API
    - |
      for i in {1..30}; do
        echo "Tentativo $i/30: Testing ${API_DOCS_BASE}/restaurant-api"
        if curl -f --max-time 15 "${API_DOCS_BASE}/restaurant-api" >/dev/null 2>&1; then
          echo "‚úÖ API docs pronte!"
          break
        fi
        sleep 10
        if [ $i -eq 30 ]; then
          echo "‚ùå TIMEOUT: API non risponde"
          exit 1
        fi
      done
    
    - echo "Pulisco cartelle client API precedenti..."
    - rm -rf restaurant admin customer

    # GENERA CLIENT PER OGNI GRUPPO
    - |
      for GROUP in $API_GROUPS; do
        SPEC_FILE="./openapi-${GROUP}.json"
        OUTPUT_DIR="./${GROUP}_api"

        echo ""
        echo "üéØ >>> Generazione client $GROUP <<<"
        
        # Scarica spec OpenAPI
        echo "üì• Scarico spec da ${API_DOCS_BASE}/${GROUP}-api"
        if curl -sSfk -o "$SPEC_FILE" "${API_DOCS_BASE}/${GROUP}-api"; then
          echo "‚úÖ Spec scaricata: $(wc -c < "$SPEC_FILE") bytes"
        else
          echo "‚ùå ERRORE: Impossibile scaricare spec per $GROUP"
          exit 1
        fi

        # Scarica response wrappers
        echo "üì• Scarico response wrappers per $GROUP..."
        curl -sSfk -o "../generator/response-wrappers-${GROUP}.json" "$WRAPPERS_ENDPOINT/${GROUP}" || echo "‚ö†Ô∏è Catalogo wrappers non disponibile"

        # GENERA CON CUSTOM GENERATOR v1.0.0-SNAPSHOT STANDALONE
        echo "üîß Genero client con custom generator v1.0.0-SNAPSHOT..."
        echo "   Debug: Usando JAR = $CUSTOM_JAR"
        
        # ‚úÖ STRATEGIA DOPPIO TENTATIVO: java -jar ‚Üí java -cp fallback
        echo "üéØ Tentativo 1/2: java -jar (tradizionale)"
        if java -jar "$CUSTOM_JAR" generate \
          -g org.openapitools.custom.CustomDartClientCodegen \
          -i "$SPEC_FILE" \
          -o "$OUTPUT_DIR" \
          -t "../generator/templates" \
          --ignore-file-override "../generator/.openapi-generator-ignore" \
          --skip-validate-spec \
          -p pubName=${GROUP}_api \
          -p pubVersion=1.0.0 \
          -p pubDescription="Greedys ${GROUP^} API client" \
          -p pubHomepage=https://greedys.it 2>/dev/null; then
          echo "‚úÖ Generazione completata con java -jar (tradizionale)"
        else
          echo "‚ö†Ô∏è Tentativo java -jar fallito, provo fallback..."
          echo "üéØ Tentativo 2/2: java -cp (classpath esplicito)"
          
          if java -cp "$CUSTOM_JAR" org.openapitools.codegen.OpenAPIGenerator generate \
            -g org.openapitools.custom.CustomDartClientCodegen \
            -i "$SPEC_FILE" \
            -o "$OUTPUT_DIR" \
            -t "../generator/templates" \
            --ignore-file-override "../generator/.openapi-generator-ignore" \
            --skip-validate-spec \
            -p pubName=${GROUP}_api \
            -p pubVersion=1.0.0 \
            -p pubDescription="Greedys ${GROUP^} API client" \
            -p pubHomepage=https://greedys.it; then
            echo "‚úÖ Generazione completata con java -cp (classpath esplicito)"
          else
            echo "‚ùå ERRORE: Entrambi i metodi falliti"
            echo "   Debug MANIFEST.MF:"
            unzip -p "$CUSTOM_JAR" META-INF/MANIFEST.MF | head -5 || echo "   MANIFEST.MF inaccessibile"
            echo "   Debug JAR structure:"
            unzip -l "$CUSTOM_JAR" | grep -E "(Main-Class|org/openapitools)" | head -5 || echo "   Struttura JAR problematica"
            exit 1
          fi
        fi

        # POST-PROCESSING
        echo "üßπ Post-processing per $GROUP..."
        
        # Rimuovi doc ResponseWrapper indesiderati
        [ -d "$OUTPUT_DIR/doc" ] && find "$OUTPUT_DIR/doc" -name "ResponseWrapper*.md" ! -name "ResponseWrapperErrorDetails.md" -delete 2>/dev/null || true
        
        # Rimuovi test ResponseWrapper indesiderati  
        [ -d "$OUTPUT_DIR/test" ] && find "$OUTPUT_DIR/test" -name "response_wrapper*.dart" ! -name "response_wrapper_error_details_test.dart" -delete 2>/dev/null || true
        
        # Pulisci import ResponseWrapper generati automaticamente
        [ -d "$OUTPUT_DIR/lib" ] && find "$OUTPUT_DIR/lib" -name "*.dart" -exec sed -i "/^import 'package:${GROUP}_api\/.*\/response_wrapper.*';$/d" {} \; 2>/dev/null || true
        
        # Aggiorna pubspec.yaml con common
        PUBSPEC="$OUTPUT_DIR/pubspec.yaml"
        if [ -f "$PUBSPEC" ] && ! grep -q "common:" "$PUBSPEC"; then
          echo "  common:" >> "$PUBSPEC"
          echo "    path: ../common" >> "$PUBSPEC"
        fi
        
        # Pulisci export ResponseWrapper da openapi.dart
        OPENAPI_FILE="$OUTPUT_DIR/lib/openapi.dart"
        [ -f "$OPENAPI_FILE" ] && sed -i "/^export 'package:.*\/response_wrapper\([^_]\|_[^e]\)/d" "$OPENAPI_FILE" 2>/dev/null || true

        rm "$SPEC_FILE"
        echo "‚úÖ Client $GROUP generato con successo!"
      done

    # COMMIT E PUSH
    - echo ""
    - echo "üì§ Commit e push delle modifiche..."
    - git add .
    - |
      if git diff-index --quiet HEAD; then
        echo "üìù Nessuna modifica da pushare"
      else
        git commit -m "ü§ñ Genera Dart clients v1.0.0-SNAPSHOT: $API_GROUPS"
        git push origin main
        echo "‚úÖ Client v1.0.0-SNAPSHOT pushati con successo!"
      fi

  only:
    - main