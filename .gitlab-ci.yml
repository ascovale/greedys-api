# Pipeline per API senza ResponseWrapper - generator standard OpenAPI
variables:
  TAG_LATEST: ${CI_REGISTRY_IMAGE}:latest
  TAG_COMMIT: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
  DART_REPO: https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
  API_DOCS_BASE: "http://api.greedys.it:8080/v3/api-docs"
  API_GROUPS: "restaurant admin customer"
  # Generator OpenAPI standard (no custom wrappers needed)
  OPENAPI_GENERATOR_VERSION: "7.10.0"

stages:
  - build
  - deploy
  - publish

cache:
  paths:
    - .m2/repository
    - node_modules/
    - tools/

build:
  image: docker:24.0.5
  stage: build
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_BUILDKIT: "1"
  script:
    - echo "Logging into Docker registry..."
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
    - echo "Building and tagging Docker image..."
    - |
      for i in 1 2 3; do \
        docker build --pull --progress=plain -t $TAG_LATEST --build-arg SPRING_PROFILES_ACTIVE="docker" . && break || { echo "docker build failed (attempt $i/3), retrying in 10s"; sleep 10; }; \
      done
    - echo "Tagging Docker image with commit tag..."
    - docker tag $TAG_LATEST $TAG_COMMIT
    - echo "Pushing Docker images..."
    - docker push $TAG_LATEST
    - docker push $TAG_COMMIT
  only:
    - main
  after_script:
    - echo "Cleaning up Docker resources..."
    - docker system prune -f

deploy:
  image: alpine:3.18
  stage: deploy
  before_script:
    - apk add --no-cache openssh-client openssh-keygen
    - mkdir -p deploy
    - cp "$ID_RSA" deploy/id_key
    - tr -d '\r' < deploy/id_key > deploy/id_key.clean && mv deploy/id_key.clean deploy/id_key
    - chmod 600 deploy/id_key
    - mkdir -p ~/.ssh && ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
    - echo "== Key sanity ==" && head -1 deploy/id_key && tail -1 deploy/id_key
    - ssh-keygen -lf deploy/id_key
    - ssh-keygen -y -f deploy/id_key > deploy/id_key.pub
    - |
      echo "== Match con authorized_keys su deployer =="
      ssh -o BatchMode=yes -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" \
        "grep -F -x -q \"$(cat deploy/id_key.pub)\" ~/.ssh/authorized_keys && echo MATCH || echo NO_MATCH"
  script:
    - ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'mkdir -p ~/greedys_api/'
    - scp -o IdentitiesOnly=yes -i deploy/id_key docker-compose.yml deploy.sh deployer@"$SERVER_IP":~/greedys_api/
    - printf '%s' "$CI_JOB_TOKEN" | ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" "docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY"
    - ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'cd ~/greedys_api/ && chmod +x ./deploy.sh && ./deploy.sh'
  only: [main]

publish:
  image: openjdk:17-slim
  stage: publish
  before_script:
    - echo "Setup ambiente per generazione Dart..."
    - apt-get update && apt-get install -y curl git
    
    # Scarica OpenAPI Generator standard
    - echo "Scarico OpenAPI Generator v${OPENAPI_GENERATOR_VERSION}..."
    - mkdir -p tools
    - curl -sSL "https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/${OPENAPI_GENERATOR_VERSION}/openapi-generator-cli-${OPENAPI_GENERATOR_VERSION}.jar" -o "tools/openapi-generator.jar"
    - export GENERATOR_JAR="$(pwd)/tools/openapi-generator.jar"
    - echo "OpenAPI Generator scaricato"
    
    # Setup GIT con PAT
    - echo "echo \$PAT" > /tmp/git-askpass.sh
    - chmod +x /tmp/git-askpass.sh
    - export GIT_ASKPASS=/tmp/git-askpass.sh
    
    - echo "Clono repo Dart API..."
    - git clone https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
    - cd greedys_api_dart_lib
    - git config user.email "ci-bot@greedys.com"
    - git config user.name "Greedys CI Bot"

  script:
    - echo "Attendo che l'API sia pronta..."
    - sleep 10
    
    # Test connessione API
    - |
      for i in {1..30}; do
        echo "Tentativo $i/30: Testing ${API_DOCS_BASE}/restaurant-api"
        if curl -f --max-time 15 "${API_DOCS_BASE}/restaurant-api" >/dev/null 2>&1; then
          echo "API docs pronte!"
          break
        fi
        sleep 10
        if [ $i -eq 30 ]; then
          echo "TIMEOUT: API non risponde"
          exit 1
        fi
      done
    
    - echo "Pulisco cartelle client API precedenti..."
    - rm -rf restaurant_api admin_api customer_api

    # GENERA CLIENT PER OGNI GRUPPO CON OPENAPI GENERATOR STANDARD
    - |
      for GROUP in $API_GROUPS; do
        SPEC_FILE="./openapi-${GROUP}.json"
        OUTPUT_DIR="./${GROUP}_api"

        echo ""
        echo ">>> Generazione client $GROUP <<<"
        
        # Scarica spec OpenAPI
        echo "Scarico spec da ${API_DOCS_BASE}/${GROUP}-api"
        if curl -sSfk -o "$SPEC_FILE" "${API_DOCS_BASE}/${GROUP}-api"; then
          echo "Spec scaricata: $(wc -c < "$SPEC_FILE") bytes"
        else
          echo "ERRORE: Impossibile scaricare spec per $GROUP"
          exit 1
        fi

        # GENERA CLIENT CON OPENAPI GENERATOR STANDARD
        echo "Genero client $GROUP con OpenAPI Generator ${OPENAPI_GENERATOR_VERSION}..."
        
        java -jar $GENERATOR_JAR generate \
          -g dart \
          -i $SPEC_FILE \
          -o $OUTPUT_DIR \
          --skip-validate-spec \
          -p pubName=${GROUP}_api \
          -p pubVersion=1.0.0 \
          -p pubDescription="Greedys ${GROUP^} API client" \
          -p pubHomepage=https://greedys.it 2>&1 | grep -v "^WARN" || true
        
        if [ ! -d "$OUTPUT_DIR" ] || [ ! -f "$OUTPUT_DIR/pubspec.yaml" ]; then
          echo "ERRORE: Generazione client $GROUP fallita"
          exit 1
        fi
        
        echo "Client $GROUP generato con successo"

        # Aggiorna versioni in dev_dependencies di pubspec.yaml
        PUBSPEC="$OUTPUT_DIR/pubspec.yaml"
        if [ -f "$PUBSPEC" ]; then
          echo "Aggiornamento dev_dependencies in pubspec.yaml..."
          # Aggiorna test se esiste, altrimenti aggiungilo
          if grep -q "test:" "$PUBSPEC"; then
            sed -i 's/test: .*/test: ">=1.24.0"/' "$PUBSPEC"
          else
            sed -i '/dev_dependencies:/a\  test: ">=1.24.0"' "$PUBSPEC"
          fi
          # Aggiungi build_runner se non esiste
          if ! grep -q "build_runner:" "$PUBSPEC"; then
            sed -i '/dev_dependencies:/a\  build_runner: ">=2.4.0"' "$PUBSPEC"
          fi
          echo "Dev dependencies aggiornate"
        fi

        rm "$SPEC_FILE"
        echo "Client $GROUP completato!"
      done

    # COMMIT E PUSH
    - echo ""
    - echo "Commit e push delle modifiche..."
    - git add .
    - |
      if git diff-index --quiet HEAD; then
        echo "Nessuna modifica da pushare"
      else
        git commit -m "Genera Dart clients v${OPENAPI_GENERATOR_VERSION}: $API_GROUPS"
        git push origin main
        echo "Client v${OPENAPI_GENERATOR_VERSION} pushati con successo!"
      fi

  only:
    - main
