# Pipeline per API senza ResponseWrapper - generator standard OpenAPI
variables:
  TAG_LATEST: ${CI_REGISTRY_IMAGE}:latest
  TAG_COMMIT: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
  DART_REPO: https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
  API_DOCS_BASE: "http://api.greedys.it:8080/v3/api-docs"
  API_GROUPS: "restaurant admin customer"
  # Generator OpenAPI standard (no custom wrappers needed)
  OPENAPI_GENERATOR_VERSION: "7.10.0"

stages:
  - build
  - deploy
  - publish
  - test

cache:
  paths:
    - .m2/repository
    - node_modules/
    - tools/

build:
  image: docker:24.0.5
  stage: build
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_BUILDKIT: "1"
  script:
    - echo "Logging into Docker registry..."
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
    - echo "Building and tagging Docker image..."
    - |
      for i in 1 2 3; do \
        docker build --pull --progress=plain -t $TAG_LATEST --build-arg SPRING_PROFILES_ACTIVE="docker" . && break || { echo "docker build failed (attempt $i/3), retrying in 10s"; sleep 10; }; \
      done
    - echo "Tagging Docker image with commit tag..."
    - docker tag $TAG_LATEST $TAG_COMMIT
    - echo "Pushing Docker images..."
    - docker push $TAG_LATEST
    - docker push $TAG_COMMIT
  after_script:
    - echo "Cleaning up Docker resources..."
    - docker system prune -f

deploy_prod:
  image: alpine:3.18
  stage: deploy
  only:
    - main
  before_script:
    - apk add --no-cache openssh-client openssh-keygen
    - mkdir -p deploy
    - cp "$ID_RSA" deploy/id_key
    - tr -d '\r' < deploy/id_key > deploy/id_key.clean && mv deploy/id_key.clean deploy/id_key
    - chmod 600 deploy/id_key
    - mkdir -p ~/.ssh && ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
    - echo "SSH Key loaded and ready"
  script:
    - ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'mkdir -p ~/greedys_api/'
    - scp -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i deploy/id_key docker-compose.yml deploy.sh nginx.conf deployer@"$SERVER_IP":~/greedys_api/
    - scp -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -r -i deploy/id_key traefik/ deployer@"$SERVER_IP":~/greedys_api/
    - printf '%s' "$CI_JOB_TOKEN" | ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" "docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY"
    - ssh -o StrictHostKeyChecking=no -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'cd ~/greedys_api/ && chmod +x ./deploy.sh && bash ./deploy.sh'

publish:
  image: eclipse-temurin:17-jdk
  stage: publish
  only:
    - main
  before_script:
    - echo "Setup ambiente per generazione Dart..."
    - apt-get update && apt-get install -y curl git
    
    # Scarica OpenAPI Generator standard
    - echo "Scarico OpenAPI Generator v${OPENAPI_GENERATOR_VERSION}..."
    - mkdir -p tools
    - curl -sSL "https://repo1.maven.org/maven2/org/openapitools/openapi-generator-cli/${OPENAPI_GENERATOR_VERSION}/openapi-generator-cli-${OPENAPI_GENERATOR_VERSION}.jar" -o "tools/openapi-generator.jar"
    - export GENERATOR_JAR="$(pwd)/tools/openapi-generator.jar"
    - echo "OpenAPI Generator scaricato"
    
    # Setup GIT con PAT
    - echo "echo \$PAT" > /tmp/git-askpass.sh
    - chmod +x /tmp/git-askpass.sh
    - export GIT_ASKPASS=/tmp/git-askpass.sh
    
    - echo "Clono repo Dart API..."
    - git clone https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
    - cd greedys_api_dart_lib
    - git config user.email "ci-bot@greedys.com"
    - git config user.name "Greedys CI Bot"

  script:
    - echo "Attendo che l'API sia pronta..."
    - sleep 20

    # Test connessione API (usa HTTP:8080 con retry e timeout aumentato)
    - |
      API_TEST_URL="http://api.greedys.it:8080/v3/api-docs/restaurant-api"
      MAX_ATTEMPTS=40
      ATTEMPT=1
      API_READY=false

      while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
        echo "Tentativo $ATTEMPT/$MAX_ATTEMPTS: Testing $API_TEST_URL"

        # Use curl to get HTTP code and avoid pipe-induced failures
        HTTP_CODE=$(curl -s --connect-timeout 10 --max-time 20 -o /dev/null -w "%{http_code}" "$API_TEST_URL" 2>/dev/null || echo "000")

        if [ "$HTTP_CODE" = "200" ]; then
          echo "✅ API docs pronte!"
          API_READY=true
          break
        else
          echo "⏳ API risponde con codice $HTTP_CODE, attendo..."
        fi

        sleep 10
        ATTEMPT=$((ATTEMPT + 1))
      done

      if [ "$API_READY" != "true" ]; then
        echo "❌ TIMEOUT: API non risponde dopo $MAX_ATTEMPTS tentativi"
        exit 1
      fi
    
    - echo "Pulisco cartelle client API precedenti..."
    - rm -rf restaurant_api admin_api customer_api

    # GENERA CLIENT PER OGNI GRUPPO CON OPENAPI GENERATOR STANDARD
    - |
      for GROUP in $API_GROUPS; do
        SPEC_FILE="./openapi-${GROUP}.json"
        OUTPUT_DIR="./${GROUP}_api"

        echo ""
        echo ">>> Generazione client $GROUP <<<"
        
        # Scarica spec OpenAPI con retry
        echo "Scarico spec da ${API_DOCS_BASE}/${GROUP}-api"
        SPEC_URL="${API_DOCS_BASE}/${GROUP}-api"
        SPEC_RETRY=0
        SPEC_MAX_RETRY=5
        
        while [ $SPEC_RETRY -lt $SPEC_MAX_RETRY ]; do
          if curl -sSLk --connect-timeout 10 --max-time 30 -o "$SPEC_FILE" "$SPEC_URL"; then
            SPEC_SIZE=$(wc -c < "$SPEC_FILE" 2>/dev/null || echo "0")
            if [ "$SPEC_SIZE" -gt 0 ]; then
              echo "✅ Spec scaricata: $SPEC_SIZE bytes"
              break
            fi
          fi
          SPEC_RETRY=$((SPEC_RETRY + 1))
          if [ $SPEC_RETRY -lt $SPEC_MAX_RETRY ]; then
            echo "⏳ Retry $SPEC_RETRY/$SPEC_MAX_RETRY in 10 secondi..."
            sleep 10
          fi
        done
        
        if [ ! -f "$SPEC_FILE" ] || [ "$(wc -c < "$SPEC_FILE" 2>/dev/null || echo 0)" -eq 0 ]; then
          echo "❌ ERRORE: Impossibile scaricare spec per $GROUP dopo $SPEC_MAX_RETRY tentativi"
          exit 1
        fi

        # GENERA CLIENT CON OPENAPI GENERATOR STANDARD
        echo "Genero client $GROUP con OpenAPI Generator ${OPENAPI_GENERATOR_VERSION}..."
        
        java -jar $GENERATOR_JAR generate \
          -g dart \
          -i $SPEC_FILE \
          -o $OUTPUT_DIR \
          --skip-validate-spec \
          -p pubName=${GROUP}_api \
          -p pubVersion=1.0.0 \
          -p pubDescription="Greedys ${GROUP^} API client" \
          -p pubHomepage=https://greedys.it 2>&1 | grep -v "^WARN" || true
        
        if [ ! -d "$OUTPUT_DIR" ] || [ ! -f "$OUTPUT_DIR/pubspec.yaml" ]; then
          echo "ERRORE: Generazione client $GROUP fallita"
          exit 1
        fi
        
        echo "Client $GROUP generato con successo"

        # Aggiorna versioni in dev_dependencies di pubspec.yaml
        PUBSPEC="$OUTPUT_DIR/pubspec.yaml"
        if [ -f "$PUBSPEC" ]; then
          echo "Aggiornamento dev_dependencies in pubspec.yaml..."
          # Aggiorna test se esiste, altrimenti aggiungilo
          if grep -q "test:" "$PUBSPEC"; then
            sed -i 's/test: .*/test: ">=1.24.0"/' "$PUBSPEC"
          else
            sed -i '/dev_dependencies:/a\  test: ">=1.24.0"' "$PUBSPEC"
          fi
          # Aggiungi build_runner se non esiste
          if ! grep -q "build_runner:" "$PUBSPEC"; then
            sed -i '/dev_dependencies:/a\  build_runner: ">=2.4.0"' "$PUBSPEC"
          fi
          echo "Dev dependencies aggiornate"
        fi

        rm "$SPEC_FILE"
        echo "Client $GROUP completato!"
      done

    # COMMIT E PUSH
    - echo ""
    - echo "Commit e push delle modifiche..."
    - git add .
    - |
      if git diff-index --quiet HEAD; then
        echo "Nessuna modifica da pushare"
      else
        git commit -m "Genera Dart clients v${OPENAPI_GENERATOR_VERSION}: $API_GROUPS"
        git push origin main
        echo "Client v${OPENAPI_GENERATOR_VERSION} pushati con successo!"
      fi

test:
  image: alpine:3.18
  stage: test
  only:
    - main
  before_script:
    - apk add --no-cache curl
  script:
    - echo "Attendo che Let's Encrypt certificato sia pronto (5-10 minuti)..."
    - sleep 30
    
    # Test HTTPS connectivity
    - |
      HTTPS_URL="https://api.greedys.it/v3/api-docs/restaurant-api"
      echo "Testing HTTPS endpoint: $HTTPS_URL"
      for i in {1..10}; do
        echo "Tentativo $i/10: Testing $HTTPS_URL"
        if curl -f --max-time 15 --insecure "$HTTPS_URL" >/dev/null 2>&1; then
          echo "✅ HTTPS funziona! Certificato pronto!"
          curl -v --max-time 15 "$HTTPS_URL" 2>&1 | grep -i "ssl\|certificate\|https" || true
          break
        fi
        sleep 10
        if [ $i -eq 10 ]; then
          echo "⚠️ HTTPS non ancora pronto, potrebbe essere in fase di setup (Let's Encrypt)"
          echo "Verificare i log di Traefik per i dettagli del certificato"
        fi
      done
    
    # Verifica servizi
    - echo "Verifica dello stato dei servizi..."
    - |
      echo "Se il certificato non è pronto, controllare:"
      echo "  1. docker service logs greedys_api_traefik | grep -i certificate"
      echo "  2. Attendere 5-10 minuti per Let's Encrypt"
      echo "  3. Verificare acme.json sul server"
