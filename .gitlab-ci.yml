# Pipeline corretta per API con generator v1.0.0-SNAPSHOT
variables:
  TAG_LATEST: ${CI_REGISTRY_IMAGE}:latest
  TAG_COMMIT: ${CI_REGISTRY_IMAGE}:${CI_COMMIT_SHORT_SHA}
  DART_REPO: https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
  API_DOCS_BASE: "http://api.greedys.it:8080/v3/api-docs"
  WRAPPERS_ENDPOINT: "http://api.greedys.it:8080/api/internal/response-wrapper-catalog"
  API_GROUPS: "restaurant admin customer"
  # Path files dal Package Registry
  CUSTOM_JAR_PATH: "tools/custom-generator.jar"
  TEMPLATES_DIR_PATH: "generator/templates"
  IGNORE_FILE_PATH: "generator/.openapi-generator-ignore"

stages:
  - build
  - deploy
  - publish

cache:
  paths:
    - .m2/repository
    - node_modules/
    - tools/

build:
  image: docker:24.0.5
  stage: build
  services:
    - docker:24.0.5-dind
  variables:
    DOCKER_BUILDKIT: "1"
  script:
    - echo "Logging into Docker registry..."
    - echo $CI_JOB_TOKEN | docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY
    - echo "Building and tagging Docker image..."
    - |
      for i in 1 2 3; do \
        docker build --pull --progress=plain -t $TAG_LATEST --build-arg SPRING_PROFILES_ACTIVE="docker" . && break || { echo "docker build failed (attempt $i/3), retrying in 10s"; sleep 10; }; \
      done
    - echo "Tagging Docker image with commit tag..."
    - docker tag $TAG_LATEST $TAG_COMMIT
    - echo "Pushing Docker images..."
    - docker push $TAG_LATEST
    - docker push $TAG_COMMIT
  only:
    - main
  after_script:
    - echo "Cleaning up Docker resources..."
    - docker system prune -f

deploy:
  image: alpine:3.18
  stage: deploy
  before_script:
    - apk add --no-cache openssh-client openssh-keygen
    - mkdir -p deploy
    - cp "$ID_RSA" deploy/id_key
    - tr -d '\r' < deploy/id_key > deploy/id_key.clean && mv deploy/id_key.clean deploy/id_key
    - chmod 600 deploy/id_key
    - mkdir -p ~/.ssh && ssh-keyscan -H "$SERVER_IP" >> ~/.ssh/known_hosts
    - echo "== Key sanity ==" && head -1 deploy/id_key && tail -1 deploy/id_key
    - ssh-keygen -lf deploy/id_key
    - ssh-keygen -y -f deploy/id_key > deploy/id_key.pub
    - |
      echo "== Match con authorized_keys su deployer =="
      ssh -o BatchMode=yes -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" \
        "grep -F -x -q \"$(cat deploy/id_key.pub)\" ~/.ssh/authorized_keys && echo MATCH || echo NO_MATCH"
  script:
    - ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'mkdir -p ~/greedys_api/'
    - scp -o IdentitiesOnly=yes -i deploy/id_key docker-compose.yml deploy.sh deployer@"$SERVER_IP":~/greedys_api/
    - printf '%s' "$CI_JOB_TOKEN" | ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" "docker login -u gitlab-ci-token --password-stdin $CI_REGISTRY"
    - ssh -o IdentitiesOnly=yes -i deploy/id_key deployer@"$SERVER_IP" 'cd ~/greedys_api/ && chmod +x ./deploy.sh && ./deploy.sh'
  only: [main]

publish:
  image: openjdk:17-slim
  stage: publish
  before_script:
    - echo "Setup ambiente per generazione Dart..."
    - apt-get update && apt-get install -y curl git unzip jq
    
    # SCARICA JAR STANDALONE E TEMPLATES DALLA VERSIONE 1.0.0-SNAPSHOT
    - echo "üì¶ Scarico JAR standalone custom e templates dal Package Registry v1.0.0-SNAPSHOT..."
    - mkdir -p tools generator/templates
    - |
      # Ricerca dinamica URL corretto per versione 1.0.0-SNAPSHOT con timestamp
      echo "ÔøΩ Ricerca versione 1.0.0-SNAPSHOT con timestamp corretto..."
      
      # Query Package Registry per trovare l'URL esatto con timestamp
      PACKAGES_JSON=$(curl -s --header "Private-Token:$PAT" \
        "https://gitlab.com/api/v4/projects/greedysgroup%2Fgreedys_generator/packages?package_type=maven")
      
      echo "üìã Packages trovati: $(echo "$PACKAGES_JSON" | jq -r 'length') packages"
      
      # Trova il package org/openapitools/custom/custom-dart-codegen con versione 1.0.0-SNAPSHOT pi√π recente
      SNAPSHOT_PACKAGE_ID=$(echo "$PACKAGES_JSON" | jq -r '.[] | select(.name == "org/openapitools/custom/custom-dart-codegen" and (.version | contains("1.0.0-SNAPSHOT"))) | .id' | head -1)
      
      if [ -z "$SNAPSHOT_PACKAGE_ID" ]; then
        echo "‚ùå ERRORE: Package 1.0.0-SNAPSHOT non trovato"
        echo "üìã Versioni disponibili:"
        echo "$PACKAGES_JSON" | jq -r '.[] | .version' | head -10
        exit 1
      fi
      
      echo "üì¶ Package ID trovato: $SNAPSHOT_PACKAGE_ID"
      
      # Ottieni i file del package
      PACKAGE_FILES=$(curl -s --header "Private-Token:$PAT" \
        "https://gitlab.com/api/v4/projects/greedysgroup%2Fgreedys_generator/packages/$SNAPSHOT_PACKAGE_ID/package_files")
      
      # Trova il JAR standalone (quello pi√π grande, ~31MB) - dinamicamente
      JAR_FILE_INFO=$(echo "$PACKAGE_FILES" | jq -r '.[] | select(.file_name | endswith("-standalone.jar")) | select(.size > 30000000) | .file_name')
      
      if [ -z "$JAR_FILE_INFO" ]; then
        echo "‚ùå ERRORE: JAR standalone non trovato"
        echo "üìã Files disponibili:"
        echo "$PACKAGE_FILES" | jq -r '.[] | .file_name + " (" + (.size | tostring) + " bytes)"'
        exit 1
      fi
      
      echo "üîΩ Download JAR standalone: $JAR_FILE_INFO"
      # Usa l'endpoint Maven Registry per scaricare il file
      curl -s --header "Private-Token:$PAT" "https://gitlab.com/api/v4/projects/greedysgroup%2Fgreedys_generator/packages/maven/org/openapitools/custom/custom-dart-codegen/1.0.0-SNAPSHOT/$JAR_FILE_INFO" -o "$CUSTOM_JAR_PATH"
      
      # Verifica JAR scaricato
      if [ ! -f "$CUSTOM_JAR_PATH" ] || [ $(stat -c%s "$CUSTOM_JAR_PATH") -lt 1000000 ]; then
        echo "‚ùå ERRORE: JAR non valido o troppo piccolo (richiesto ~31MB)"
        exit 1
      fi
      echo "‚úÖ JAR scaricato: $(stat -c%s $CUSTOM_JAR_PATH) bytes"
      
      # Trova il templates ZIP usando l'API dinamica
      TEMPLATES_FILE_INFO=$(echo "$PACKAGE_FILES" | jq -r '.[] | select(.file_name | endswith("-templates.zip")) | .file_name')
      
      if [ -z "$TEMPLATES_FILE_INFO" ]; then
        echo "‚ùå ERRORE: Templates ZIP non trovato"
        echo "üìã Files disponibili:"
        echo "$PACKAGE_FILES" | jq -r '.[] | .file_name + " (" + (.size | tostring) + " bytes)"'
        exit 1
      fi
      
      echo "üîΩ Download templates ZIP: $TEMPLATES_FILE_INFO"
      # Usa l'endpoint Maven Registry per scaricare il file
      curl -s --header "Private-Token:$PAT" "https://gitlab.com/api/v4/projects/greedysgroup%2Fgreedys_generator/packages/maven/org/openapitools/custom/custom-dart-codegen/1.0.0-SNAPSHOT/$TEMPLATES_FILE_INFO" -o "templates.zip"
      
      # Verifica templates ZIP
      if [ ! -f "templates.zip" ] || [ $(stat -c%s "templates.zip") -lt 1000 ]; then
        echo "‚ùå ERRORE: Templates ZIP non valido"
        exit 1
      fi
      
      # Estrai templates
      unzip -q templates.zip -d $TEMPLATES_DIR_PATH/
      echo "‚úÖ Templates estratti: $(find $TEMPLATES_DIR_PATH -name '*.mustache' | wc -l) files"
      
      # Scarica ignore file direttamente con nome preciso e rinomina
      curl -s --header "Private-Token:$PAT" "https://gitlab.com/api/v4/projects/greedysgroup%2Fgreedys_generator/packages/maven/org/openapitools/custom/custom-dart-codegen/1.0.0-SNAPSHOT/custom-dart-codegen-1.0.0-20251002.113120-1-openapi-generator.ignore" -o "$IGNORE_FILE_PATH"
      
      if [ ! -f "$IGNORE_FILE_PATH" ] || [ $(stat -c%s "$IGNORE_FILE_PATH") -lt 10 ]; then
        echo "‚ùå ERRORE: Ignore file non valido"
        exit 1
      fi
      echo "‚úÖ Ignore file scaricato: $(stat -c%s $IGNORE_FILE_PATH) bytes"
      

    # Setup GIT con PAT
    - echo "echo \$PAT" > /tmp/git-askpass.sh
    - chmod +x /tmp/git-askpass.sh
    - export GIT_ASKPASS=/tmp/git-askpass.sh
    
    # Salva i path assoluti di JAR, TEMPLATES e IGNORE FILE prima di cambiare directory
    - export CUSTOM_JAR="$(pwd)/$CUSTOM_JAR_PATH"
    - export IGNORE_FILE="$(pwd)/$IGNORE_FILE_PATH"
    - export TEMPLATES_DIR="$(pwd)/$TEMPLATES_DIR_PATH"
    - echo "JAR configurato:" $CUSTOM_JAR "($(stat -c%s $CUSTOM_JAR) bytes)"
    - echo "Templates dir configurato:" $TEMPLATES_DIR
    - echo "Ignore file configurato:" $IGNORE_FILE "($(stat -c%s $IGNORE_FILE) bytes)"

    - echo "Clono repo Dart API..."
    - git clone https://gitlab.com/GreedysGroup/greedys_api_dart_lib.git
    - cd greedys_api_dart_lib
    - git config user.email "ci-bot@greedys.com"
    - git config user.name "Greedys CI Bot"

  script:
    - echo "‚è≥ Attendo che l'API sia pronta..."
    - sleep 10
    
    # Test connessione API
    - |
      for i in {1..30}; do
        echo "Tentativo $i/30: Testing ${API_DOCS_BASE}/restaurant-api"
        if curl -f --max-time 15 "${API_DOCS_BASE}/restaurant-api" >/dev/null 2>&1; then
          echo "‚úÖ API docs pronte!"
          break
        fi
        sleep 10
        if [ $i -eq 30 ]; then
          echo "‚ùå TIMEOUT: API non risponde"
          exit 1
        fi
      done
    
    - echo "Pulisco cartelle client API precedenti..."
    - rm -rf restaurant admin customer

    # GENERA CLIENT PER OGNI GRUPPO
    - |
      for GROUP in $API_GROUPS; do
        SPEC_FILE="./openapi-${GROUP}.json"
        OUTPUT_DIR="./${GROUP}_api"

        echo ""
        echo "üéØ >>> Generazione client $GROUP <<<"
        
        # Scarica spec OpenAPI
        echo "üì• Scarico spec da ${API_DOCS_BASE}/${GROUP}-api"
        if curl -sSfk -o "$SPEC_FILE" "${API_DOCS_BASE}/${GROUP}-api"; then
          echo "‚úÖ Spec scaricata: $(wc -c < "$SPEC_FILE") bytes"
        else
          echo "‚ùå ERRORE: Impossibile scaricare spec per $GROUP"
          exit 1
        fi

        # Scarica response wrappers per questo gruppo
        WRAPPERS_FILE="response-wrappers-${GROUP}.json"
        
        curl -sSfk "$WRAPPERS_ENDPOINT/${GROUP}" | jq -r '.value | fromjson' > "$WRAPPERS_FILE"
        
        if [ ! -f "$WRAPPERS_FILE" ] || [ $(stat -c%s "$WRAPPERS_FILE") -lt 10 ]; then
          echo "‚ùå ERRORE: Catalogo wrappers non valido per $GROUP"
          exit 1
        fi
        
        WRAPPER_COUNT=$(jq -r '.entries | length' "$WRAPPERS_FILE")
        echo "‚úÖ Catalogo $GROUP: $WRAPPER_COUNT wrappers"

        # GENERA CLIENT CON CUSTOM GENERATOR
        echo "üîß Genero client $GROUP con custom generator..."
        
        echo "üìã Path files per $GROUP:"
        echo "   SPEC_FILE: $SPEC_FILE (realpath: $(realpath "$SPEC_FILE" 2>/dev/null || echo "NON TROVATO"))"
        echo "   OUTPUT_DIR: $OUTPUT_DIR (realpath: $(realpath "$OUTPUT_DIR" 2>/dev/null || echo "NON ESISTE ANCORA"))"
        echo "   CUSTOM_JAR: $CUSTOM_JAR (realpath: $(realpath "$CUSTOM_JAR" 2>/dev/null || echo "NON TROVATO"))"
        echo "   TEMPLATES_DIR: $TEMPLATES_DIR (realpath: $(realpath "$TEMPLATES_DIR" 2>/dev/null || echo "NON TROVATO"))"
        echo "   IGNORE_FILE: $IGNORE_FILE (realpath: $(realpath "$IGNORE_FILE" 2>/dev/null || echo "NON TROVATO"))"
        echo "   WRAPPERS_FILE: $WRAPPERS_FILE (realpath: $(realpath "$WRAPPERS_FILE" 2>/dev/null || echo "NON TROVATO"))"
        
        echo ""
        echo "ÔøΩ Verifica CUSTOM_JAR:"
        if [ -f "$CUSTOM_JAR" ]; then
          echo "   ‚úÖ Esiste: $CUSTOM_JAR"
          echo "   üìè Dimensione: $(stat -c%s "$CUSTOM_JAR") bytes"
          echo "   üîç Tipo file: $(file "$CUSTOM_JAR" 2>/dev/null || echo "comando file non disponibile")"
        else
          echo "   ‚ùå FILE JAR NON TROVATO: $CUSTOM_JAR"
        fi
        
        echo ""
        echo " Contenuto IGNORE_FILE ($IGNORE_FILE):"
        if [ -f "$IGNORE_FILE" ]; then
          cat "$IGNORE_FILE"
        else
          echo "‚ùå FILE NON TROVATO!"
        fi
        echo ""
        
        echo "üîß Eseguo generazione client $GROUP..."
        
        # Copia templates e ignore file nella directory corrente (come nello script di test)
        cp -r "$TEMPLATES_DIR" "./templates"
        cp "$IGNORE_FILE" "./.openapi-generator-ignore"
        
        java -jar $CUSTOM_JAR generate \
          -g org.openapitools.custom.CustomDartClientCodegen \
          -i $SPEC_FILE \
          -o $OUTPUT_DIR \
          -t templates \
          --ignore-file-override .openapi-generator-ignore \
          --skip-validate-spec \
          -p pubName=${GROUP}_api \
          -p pubVersion=1.0.0 \
          -p pubDescription="Greedys ${GROUP^} API client" \
          -p pubHomepage=https://greedys.it >/dev/null 2>&1 || { echo "‚ùå ERRORE: Generazione client $GROUP fallita"; exit 1; }
        
        echo "‚úÖ Client $GROUP generato con successo"
        
        # VERIFICA: Controlla se i ResponseWrapper sono stati generati nonostante l'ignore file
        echo "üîç Verifica ResponseWrapper generati in $OUTPUT_DIR:"
        GENERATED_MODELS=$(find "$OUTPUT_DIR/lib/src/model" -name "response_wrapper*.dart" 2>/dev/null | wc -l)
        GENERATED_DOCS=$(find "$OUTPUT_DIR/doc" -name "ResponseWrapper*.md" 2>/dev/null | wc -l)
        GENERATED_TESTS=$(find "$OUTPUT_DIR/test" -name "response_wrapper*.dart" 2>/dev/null | wc -l)
        echo "   Models: $GENERATED_MODELS files"
        echo "   Docs: $GENERATED_DOCS files"
        echo "   Tests: $GENERATED_TESTS files"
        if [ "$GENERATED_MODELS" -gt 1 ] || [ "$GENERATED_DOCS" -gt 1 ] || [ "$GENERATED_TESTS" -gt 1 ]; then
          echo "   ‚ö†Ô∏è  Ignore file NON ha funzionato - file generati nonostante ignore"
        else
          echo "   ‚úÖ Ignore file funziona correttamente"
        fi

        # Aggiorna pubspec.yaml con common
        PUBSPEC="$OUTPUT_DIR/pubspec.yaml"
        if [ -f "$PUBSPEC" ] && ! grep -q "common:" "$PUBSPEC"; then
          echo "  common:" >> "$PUBSPEC"
          echo "    path: ../common" >> "$PUBSPEC"
        fi
        
        # Pulisci export ResponseWrapper da openapi.dart
        OPENAPI_FILE="$OUTPUT_DIR/lib/openapi.dart"
        [ -f "$OPENAPI_FILE" ] && sed -i "/^export 'package:.*\/response_wrapper\([^_]\|_[^e]\)/d" "$OPENAPI_FILE" 2>/dev/null || true

        rm "$SPEC_FILE"
        echo "‚úÖ Client $GROUP generato con successo!"
      done

    # COMMIT E PUSH
    - echo ""
    - echo "üì§ Commit e push delle modifiche..."
    - git add .
    - |
      if git diff-index --quiet HEAD; then
        echo "üìù Nessuna modifica da pushare"
      else
        git commit -m "ü§ñ Genera Dart clients v1.0.0-SNAPSHOT: $API_GROUPS"
        git push origin main
        echo "‚úÖ Client v1.0.0-SNAPSHOT pushati con successo!"
      fi

  only:
    - main