```
EVENT OUTBOX PRODUCER - FLOW DIAGRAM
=====================================

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ BUSINESS SERVICE LAYER (Application)                            â”‚
â”‚ CustomerReservationService, OrderService, etc.                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â”‚ 1. createReservation(...) or createOrder(...)
                       â”‚    Within @Transactional method
                       â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ BEGIN TRANSACTION               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ INSERT INTO Reservation table           â”‚
          â”‚ INSERT INTO Order table (etc)           â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ â­ KEY STEP: INSERT INTO event_outbox               â”‚
          â”‚                                                     â”‚
          â”‚ EventOutbox record:                                 â”‚
          â”‚   - event_id: "RES-REQ-123-2025-01-20T10:30"       â”‚
          â”‚   - event_type: "RESERVATION_REQUESTED"            â”‚
          â”‚   - aggregate_type: "RESTAURANT"                   â”‚
          â”‚   - aggregate_id: 5 (restaurant ID)                â”‚
          â”‚   - status: "PENDING"                              â”‚
          â”‚   - payload: {...full event data...}               â”‚
          â”‚   - created_at: NOW()                              â”‚
          â”‚   - published_at: NULL                             â”‚
          â”‚                                                     â”‚
          â”‚ âœ… ATOMIC: Same transaction as Reservation         â”‚
          â”‚ âœ… GUARANTEED: If this INSERT succeeds,            â”‚
          â”‚    event will eventually be published              â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ COMMIT (or ROLLBACK on error)   â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼ âœ… All-or-nothing guarantee
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚ Transaction complete                â”‚
          â”‚ Reservation CREATED + EventOutbox   â”‚
          â”‚ PERSISTED atomically                â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â”‚ (Minutes or hours can pass...)
                               â”‚ Server might crash here!
                               â”‚ But event is already safely in DB
                               â”‚
                               â–¼ (Async polling - separate scheduler)

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ EVENT OUTBOX ORCHESTRATOR (Layer 1 - PRODUCER)                  â”‚
â”‚ Package: com.application.common.service.notification.orchestrator
â”‚ Class: EventOutboxOrchestrator                                  â”‚
â”‚ Triggers: @Scheduled(fixedDelay=1000ms, initialDelay=2000ms)   â”‚
â”‚ Thread: Spring scheduled executor (configurable pool)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼ Every 1 second
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ STEP 1: POLL EVENTOUTBOX              â”‚
        â”‚                                      â”‚
        â”‚ Query:                               â”‚
        â”‚ SELECT * FROM event_outbox           â”‚
        â”‚ WHERE status = 'PENDING'             â”‚
        â”‚ LIMIT 100                            â”‚
        â”‚ ORDER BY created_at ASC              â”‚
        â”‚                                      â”‚
        â”‚ Result: List<EventOutbox> events     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ STEP 2: FOR EACH EVENT            â”‚
        â”‚                                  â”‚
        â”‚ â”œâ”€ Extract:                      â”‚
        â”‚ â”‚  â”œâ”€ eventId                    â”‚
        â”‚ â”‚  â”œâ”€ eventType                  â”‚
        â”‚ â”‚  â”œâ”€ aggregateType (KEY!)       â”‚
        â”‚ â”‚  â”œâ”€ aggregateId                â”‚
        â”‚ â”‚  â”œâ”€ payload                    â”‚
        â”‚ â”‚                                â”‚
        â”‚ â””â”€ Actions (3 per event):        â”‚
        â”‚    â”œâ”€ 2a. Try INSERT ProcessedEvent
        â”‚    â”œâ”€ 2b. Publish to RabbitMQ    â”‚
        â”‚    â””â”€ 2c. Mark PROCESSED         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚          â”‚          â”‚
            â”Œâ”€â”€â”€â–¼â”€â”€â”   â”Œâ”€â”€â”€â–¼â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”
            â”‚ 2a   â”‚   â”‚ 2b   â”‚  â”‚ 2c   â”‚
            â””â”€â”€â”¬â”€â”€â”€â”˜   â””â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”˜
               â”‚          â”‚         â”‚
               â–¼          â–¼         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 2A: IDEMPOTENCY CHECK (Level 1)           â”‚
        â”‚                                          â”‚
        â”‚ ProcessedEvent.save({                     â”‚
        â”‚   event_id: "RES-REQ-123",               â”‚
        â”‚   status: PROCESSING                     â”‚
        â”‚ })                                       â”‚
        â”‚                                          â”‚
        â”‚ Table constraint: UNIQUE(event_id)      â”‚
        â”‚                                          â”‚
        â”‚ â”œâ”€ If SUCCESS â†’ new event, proceed       â”‚
        â”‚ â””â”€ If UNIQUE VIOLATION â†’                 â”‚
        â”‚    Event already processed               â”‚
        â”‚    SKIP (don't publish again)            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼ (Only if new event)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 2B: PUBLISH TO RABBITMQ                 â”‚
        â”‚                                         â”‚
        â”‚ Key: aggregateType determines queue:    â”‚
        â”‚                                         â”‚
        â”‚ aggregateType = "RESTAURANT"            â”‚
        â”‚   â””â”€ Publish to:                        â”‚
        â”‚      notification.restaurant            â”‚
        â”‚                                         â”‚
        â”‚ aggregateType = "CUSTOMER"              â”‚
        â”‚   â””â”€ Publish to:                        â”‚
        â”‚      notification.customer              â”‚
        â”‚                                         â”‚
        â”‚ aggregateType = "AGENCY"                â”‚
        â”‚   â””â”€ Publish to:                        â”‚
        â”‚      notification.agency                â”‚
        â”‚                                         â”‚
        â”‚ aggregateType = "ADMIN"                 â”‚
        â”‚   â””â”€ Publish to:                        â”‚
        â”‚      notification.admin                 â”‚
        â”‚                                         â”‚
        â”‚ MESSAGE CONTENT:                        â”‚
        â”‚ {                                       â”‚
        â”‚   "event_id": "RES-REQ-123",           â”‚
        â”‚   "event_type": "RESERVATION_REQUESTED",
        â”‚   "aggregate_type": "RESTAURANT",       â”‚
        â”‚   "aggregate_id": 5,                    â”‚
        â”‚   "payload": {                          â”‚
        â”‚     "reservation_id": "RES-456",        â”‚
        â”‚     "restaurant_id": 5,                 â”‚
        â”‚     "customer_name": "John",            â”‚
        â”‚     "party_size": 4,                    â”‚
        â”‚     "time": "20:00",                    â”‚
        â”‚     ...more fields...                   â”‚
        â”‚   }                                     â”‚
        â”‚ }                                       â”‚
        â”‚                                         â”‚
        â”‚ âœ… IMPORTANT: This is 1 GENERIC message â”‚
        â”‚    NO DISAGGREGATION (that's Layer 2)   â”‚
        â”‚    NO recipient list included           â”‚
        â”‚    NO channel preferences               â”‚
        â”‚    Just: "Event happened for this type" â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼ (Success)
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ 2C: MARK PROCESSED IN EVENTOUTBOX     â”‚
        â”‚                                      â”‚
        â”‚ UPDATE event_outbox                  â”‚
        â”‚ SET status = 'PROCESSED',            â”‚
        â”‚     published_at = NOW()             â”‚
        â”‚ WHERE event_id = ...                 â”‚
        â”‚                                      â”‚
        â”‚ âœ… Event marked published            â”‚
        â”‚    Won't be polled again             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚
                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ RABBITMQ BROKER                                              â”‚
â”‚ Topic Exchange: notifications.exchange                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
       â”‚               â”‚               â”‚              â”‚
       â–¼               â–¼               â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚notification
   â”‚.restaurant  â”‚notification
   â”‚.customer  â”‚notification
   â”‚.agency    â”‚notification
   â”‚.admin   â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚               â”‚               â”‚              â”‚
       â”‚ (Message      â”‚ (Message      â”‚ (Message     â”‚ (Message
       â”‚  waiting)     â”‚  waiting)     â”‚  waiting)    â”‚  waiting)
       â”‚               â”‚               â”‚              â”‚
       â–¼               â–¼               â–¼              â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚ LISTENERS (consume from queues)                    â”‚
   â”‚                                                    â”‚
   â”‚ @RabbitListener(queues="notification.restaurant") â”‚
   â”‚ RestaurantNotificationListener                     â”‚
   â”‚                                                    â”‚
   â”‚ @RabbitListener(queues="notification.customer")   â”‚
   â”‚ CustomerNotificationListener                       â”‚
   â”‚                                                    â”‚
   â”‚ @RabbitListener(queues="notification.agency")     â”‚
   â”‚ AgencyUserNotificationListener                     â”‚
   â”‚                                                    â”‚
   â”‚ @RabbitListener(queues="notification.admin")      â”‚
   â”‚ AdminNotificationListener                          â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚                              â”‚
       â”‚ (Message handed off          â”‚ (Disaggregation
       â”‚  to listener)                â”‚  and persistence
       â”‚                              â”‚  happens here
       â–¼                              â”‚ in Layer 2)
```

SEQUENCE DIAGRAM - TIMELINE
============================

```
    Time (ms)    Event

    0:000        Event triggered (ReservationRequested)
    â”œâ”€ Business service runs
    â”œâ”€ INSERT Reservation
    â”œâ”€ INSERT EventOutbox (PENDING)
    â””â”€ COMMIT âœ…

    1:000        EventOutboxOrchestrator cycle starts
    â”œâ”€ Query EventOutbox WHERE status='PENDING'
    â”œâ”€ Found 1 event
    â”œâ”€ Try INSERT ProcessedEvent(eventId)
    â”œâ”€ SUCCESS (first time)
    â”œâ”€ Publish to RabbitMQ notification.restaurant
    â”œâ”€ UPDATE EventOutbox SET status='PROCESSED'
    â”œâ”€ Log: "âœ… Published event RES-REQ-123"
    â””â”€ Cycle complete

    1:005        RabbitMQ delivers message

    1:010        RestaurantNotificationListener receives
    â”œâ”€ Parse message
    â”œâ”€ Check idempotency (eventId not seen before)
    â”œâ”€ Get RestaurantUserOrchestrator
    â”œâ”€ Call disaggregateAndProcess()
    â”‚  â”œâ”€ Load 10 restaurant staff
    â”‚  â”œâ”€ For each staff Ã— channels
    â”‚  â””â”€ Create 20 notification records
    â”œâ”€ Persist 20 records to DB
    â”œâ”€ ACK to RabbitMQ
    â””â”€ Complete

    1:100        Done - 100ms total latency
```

KEY CHARACTERISTICS
===================

ğŸ”¹ RESPONSIBILITY:
   - Polls EventOutbox table
   - Publishes 1 generic message per event
   - Routes by aggregateType to correct queue
   - Marks event as PROCESSED
   - NO disaggregation logic here

ğŸ”¹ IDEMPOTENCY:
   - ProcessedEvent table (UNIQUE constraint on eventId)
   - Prevents duplicate RabbitMQ messages
   - If publish fails â†’ stays in EventOutbox
   - Will retry next cycle

ğŸ”¹ MESSAGE VOLUME:
   - Input: N events in EventOutbox
   - Output: N messages to RabbitMQ
   - 1:1 mapping (generic messages)
   - Disaggregation to 1000s records happens LATER in Layer 2

ğŸ”¹ ERROR HANDLING:
   - If RabbitMQ down: exception caught, event stays PENDING
   - Next cycle: retry
   - No infinite retry protection (potential issue)
   - ProcessedEvent update failures: event might be published twice

ğŸ”¹ PERFORMANCE:
   - Polls every 1 second (configurable)
   - Batch limit: 100 events per cycle
   - Non-blocking (async scheduling)
   - Can handle 100 events/sec = 6000 events/min

ğŸ”¹ THREADING:
   - Single scheduler thread (or pool depending on config)
   - No concurrent updates to same event
   - EventOutbox status='PENDING' is safe for batch processing
```

---

**Document Version**: 1.0  
**Last Updated**: November 23, 2025  
**Component**: Event Outbox Producer (Layer 1)
