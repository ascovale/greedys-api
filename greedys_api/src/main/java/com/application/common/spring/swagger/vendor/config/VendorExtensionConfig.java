package com.application.common.spring.swagger.vendor.config;

import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

import org.springframework.boot.context.event.ApplicationReadyEvent;
import org.springframework.context.event.EventListener;
import org.springframework.core.annotation.Order;
import org.springframework.stereotype.Component;

import com.application.common.spring.swagger.vendor.VendorExtensionRegistry;
import com.application.common.spring.swagger.vendor.extensions.ApiVersionExtension;
import com.application.common.spring.swagger.vendor.extensions.RateLimitExtension;
import com.application.common.spring.swagger.vendor.extensions.ResponseWrapperExtension;
import com.application.common.spring.swagger.vendor.extensions.SimpleVendorExtension;

import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;

/**
 * Configuratore che registra le vendor extensions predefinite all'avvio dell'applicazione
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class VendorExtensionConfig {
    
    private final VendorExtensionRegistry vendorExtensionRegistry;
    
    @EventListener(ApplicationReadyEvent.class)
    @Order(100) // Esegue dopo l'avvio dell'app ma prima del preload delle specifiche
    public void initializeVendorExtensions() {
        try {
            log.info("Initializing vendor extensions...");
            
            // 1. Extensions globali
            registerGlobalExtensions();
            
            // 2. Extensions per schemi wrapper
            registerWrapperExtensions();
            
            // 3. Extensions per rate limiting (esempio)
            registerRateLimitExtensions();
            
            // 4. Extensions personalizzate per Greedys API
            registerGreedysSpecificExtensions();
            
            log.info("Vendor extensions initialized successfully - {}", vendorExtensionRegistry.getStats());
            
        } catch (Exception e) {
            log.error("Failed to initialize vendor extensions: {}", e.getMessage(), e);
        }
    }
    
    private void registerGlobalExtensions() {
        // Info versione API
        vendorExtensionRegistry.register(new ApiVersionExtension(
            "1.0.0", 
            LocalDateTime.now().format(DateTimeFormatter.ISO_LOCAL_DATE_TIME)
        ));
        
        // Info generatore
        vendorExtensionRegistry.register(SimpleVendorExtension.global(
            "x-generator-info", 
            java.util.Map.of(
                "name", "Greedys Swagger Generator",
                "version", "2.0",
                "features", java.util.List.of("auto-wrapper-detection", "smart-error-codes", "vendor-extensions")
            )
        ));
    }
    
    private void registerWrapperExtensions() {
        // Extension per tutti gli schemi wrapper
        vendorExtensionRegistry.register(new ResponseWrapperExtension());
        
        // Extension specifica per wrapper di errore
        vendorExtensionRegistry.register(SimpleVendorExtension.schema(
            "x-error-wrapper",
            java.util.Map.of(
                "isErrorWrapper", true,
                "standardFields", java.util.List.of("message", "timestamp", "data")
            ),
            "ResponseWrapperErrorDetails"
        ));
    }
    
    private void registerRateLimitExtensions() {
        // Rate limit per operazioni di modifica
        vendorExtensionRegistry.register(new RateLimitExtension(
            60,    // 60 requests per minute
            10,    // burst limit of 10
            "user" // per user
        ));
    }
    
    private void registerGreedysSpecificExtensions() {
        // Extension per identificare API Greedys
        vendorExtensionRegistry.register(SimpleVendorExtension.global(
            "x-greedys-api",
            java.util.Map.of(
                "service", "restaurant-reservation",
                "domain", "food-delivery",
                "architecture", "microservices",
                "responsePattern", "wrapper-based"
            )
        ));
        
        // Extension per schemi DTO
        vendorExtensionRegistry.register(SimpleVendorExtension.schema(
            "x-dto-info",
            java.util.Map.of(
                "autoGenerated", true,
                "validationEnabled", true,
                "serializationFormat", "JSON"
            ),
            "*" // Applica a tutti gli schemi che finiscono con DTO (condizione nel codice)
        ));
    }
}
