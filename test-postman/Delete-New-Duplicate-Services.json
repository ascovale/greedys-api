{
  "info": {
    "_postman_id": "cleanup-duplicate-services",
    "name": "Cleanup Duplicate Services - DELETE NEW ONES",
    "description": "Remove NEW duplicate services (152, 153, 154) keeping the OLD ones (102, 103, 104)",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "item": [
    {
      "name": "üîê STEP 1: Admin Login",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('\\nüîê ADMIN LOGIN');",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    pm.environment.set('adminToken', jsonData.jwt);",
              "    console.log('‚úÖ Admin token saved');",
              "} else {",
              "    console.log('‚ùå Admin login failed:', pm.response.text());",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "POST",
        "header": [
          {"key": "Content-Type", "value": "application/json"}
        ],
        "body": {
          "mode": "raw",
          "raw": "{\"username\": \"{{adminEmail}}\", \"password\": \"{{adminPassword}}\", \"rememberMe\": true}"
        },
        "url": {
          "raw": "{{baseUrl}}/admin/auth/login",
          "host": ["{{baseUrl}}"],
          "path": ["admin", "auth", "login"]
        }
      }
    },
    {
      "name": "üóëÔ∏è STEP 2: Delete NEW Colazione Service (ID: 152)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('\\nüóëÔ∏è DELETING NEW Colazione Service (ID: 152)');",
              "if (pm.response.code === 200) {",
              "    console.log('‚úÖ Service 152 (NEW Colazione) deleted successfully');",
              "} else if (pm.response.code === 404) {",
              "    console.log('‚ÑπÔ∏è Service 152 not found (already deleted?)');",
              "} else {",
              "    console.log('‚ùå Failed to delete service 152:', pm.response.text());",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "header": [
          {"key": "Authorization", "value": "Bearer {{adminToken}}"}
        ],
        "url": {
          "raw": "{{baseUrl}}/admin/service/152",
          "host": ["{{baseUrl}}"],
          "path": ["admin", "service", "152"]
        }
      }
    },
    {
      "name": "üóëÔ∏è STEP 3: Delete NEW Pranzo Service (ID: 153)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('\\nüóëÔ∏è DELETING NEW Pranzo Service (ID: 153)');",
              "if (pm.response.code === 200) {",
              "    console.log('‚úÖ Service 153 (NEW Pranzo) deleted successfully');",
              "} else if (pm.response.code === 404) {",
              "    console.log('‚ÑπÔ∏è Service 153 not found (already deleted?)');",
              "} else {",
              "    console.log('‚ùå Failed to delete service 153:', pm.response.text());",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "header": [
          {"key": "Authorization", "value": "Bearer {{adminToken}}"}
        ],
        "url": {
          "raw": "{{baseUrl}}/admin/service/153",
          "host": ["{{baseUrl}}"],
          "path": ["admin", "service", "153"]
        }
      }
    },
    {
      "name": "üóëÔ∏è STEP 4: Delete NEW Cena Service (ID: 154)",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('\\nüóëÔ∏è DELETING NEW Cena Service (ID: 154)');",
              "if (pm.response.code === 200) {",
              "    console.log('‚úÖ Service 154 (NEW Cena) deleted successfully');",
              "} else if (pm.response.code === 404) {",
              "    console.log('‚ÑπÔ∏è Service 154 not found (already deleted?)');",
              "} else {",
              "    console.log('‚ùå Failed to delete service 154:', pm.response.text());",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "DELETE",
        "header": [
          {"key": "Authorization", "value": "Bearer {{adminToken}}"}
        ],
        "url": {
          "raw": "{{baseUrl}}/admin/service/154",
          "host": ["{{baseUrl}}"],
          "path": ["admin", "service", "154"]
        }
      }
    },
    {
      "name": "‚úÖ STEP 5: Verify Services After Cleanup",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('\\n‚úÖ VERIFYING SERVICES AFTER CLEANUP');",
              "console.log('='.repeat(50));",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    console.log('üìä Services remaining:', jsonData.length);",
              "    console.log('');",
              "    ",
              "    jsonData.forEach(function(service, index) {",
              "        console.log('‚úÖ Service ' + (index + 1) + ':');",
              "        console.log('   ID: ' + service.id);",
              "        console.log('   Name: ' + service.name);",
              "        console.log('   Active: ' + service.active);",
              "        console.log('   Enabled: ' + service.enabled);",
              "        console.log('');",
              "    });",
              "    ",
              "    var servicesByName = {};",
              "    var stillHasDuplicates = false;",
              "    ",
              "    jsonData.forEach(function(service) {",
              "        if (!servicesByName[service.name]) {",
              "            servicesByName[service.name] = 0;",
              "        }",
              "        servicesByName[service.name]++;",
              "    });",
              "    ",
              "    console.log('üîç DUPLICATE CHECK:');",
              "    Object.keys(servicesByName).forEach(function(name) {",
              "        var count = servicesByName[name];",
              "        if (count > 1) {",
              "            console.log('   ‚ùå ' + name + ': ' + count + ' duplicates still exist');",
              "            stillHasDuplicates = true;",
              "        } else {",
              "            console.log('   ‚úÖ ' + name + ': Unique service');",
              "        }",
              "    });",
              "    ",
              "    if (!stillHasDuplicates) {",
              "        console.log('');",
              "        console.log('üéâ SUCCESS: All duplicate services have been removed!');",
              "        console.log('   Now only the OLD services (102, 103, 104) remain.');",
              "        console.log('   Next step: Create slots for these services to make them active.');",
              "    }",
              "} else {",
              "    console.log('‚ùå Failed to get services:', pm.response.text());",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [
          {"key": "Authorization", "value": "Bearer {{adminToken}}"}
        ],
        "url": {
          "raw": "{{baseUrl}}/admin/restaurant/3/services",
          "host": ["{{baseUrl}}"],
          "path": ["admin", "restaurant", "3", "services"]
        }
      }
    },
    {
      "name": "üëÅÔ∏è STEP 6: Verify Customer View After Cleanup",
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "console.log('\\nüëÅÔ∏è VERIFYING CUSTOMER VIEW AFTER CLEANUP');",
              "console.log('='.repeat(50));",
              "",
              "if (pm.response.code === 200) {",
              "    var jsonData = pm.response.json();",
              "    console.log('üëÅÔ∏è Public services visible:', jsonData.length);",
              "    console.log('');",
              "    ",
              "    var publicDuplicates = {};",
              "    ",
              "    jsonData.forEach(function(service, index) {",
              "        console.log('üëÅÔ∏è Public Service ' + (index + 1) + ':');",
              "        console.log('   ID: ' + service.id);",
              "        console.log('   Name: ' + service.name);",
              "        console.log('   Slots: ' + (service.slots ? service.slots.length : 0));",
              "        console.log('');",
              "        ",
              "        if (!publicDuplicates[service.name]) {",
              "            publicDuplicates[service.name] = 0;",
              "        }",
              "        publicDuplicates[service.name]++;",
              "    });",
              "    ",
              "    console.log('üîç PUBLIC DUPLICATE CHECK:');",
              "    var hasPublicDuplicates = false;",
              "    Object.keys(publicDuplicates).forEach(function(name) {",
              "        var count = publicDuplicates[name];",
              "        if (count > 1) {",
              "            console.log('   ‚ùå ' + name + ': ' + count + ' duplicates visible to customers');",
              "            hasPublicDuplicates = true;",
              "        } else {",
              "            console.log('   ‚úÖ ' + name + ': Single service visible');",
              "        }",
              "    });",
              "    ",
              "    if (!hasPublicDuplicates) {",
              "        console.log('');",
              "        console.log('üéâ EXCELLENT: No duplicate services visible to customers!');",
              "        console.log('   Original problem resolved: \"test@test.it ha tanti servizi uguali\"');",
              "    }",
              "} else {",
              "    console.log('‚ùå Failed to get public services:', pm.response.text());",
              "}"
            ],
            "type": "text/javascript"
          }
        }
      ],
      "request": {
        "method": "GET",
        "header": [],
        "url": {
          "raw": "{{baseUrl}}/customer/restaurant/3/services",
          "host": ["{{baseUrl}}"],
          "path": ["customer", "restaurant", "3", "services"]
        }
      }
    }
  ],
  "variable": [
    {
      "key": "baseUrl",
      "value": "https://api.greedys.it",
      "type": "string"
    },
    {
      "key": "adminEmail", 
      "value": "ascolesevalentino@gmail.com",
      "type": "string"
    },
    {
      "key": "adminPassword",
      "value": "Minosse100%",
      "type": "string"
    }
  ]
}