{
	"info": {
		"_postman_id": "restaurant-registration-flow-v2",
		"name": "Greedy's Restaurant Enablement Flow (Existing Restaurant)",
		"description": "Workflow for enabling an existing restaurant (test@test.it) - NO CREATION, just enablement through admin approval",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Step 1: Admin Login",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// === STEP 1: ADMIN LOGIN ===",
							"console.log('\\nğŸ“‹ STEP 1: ADMIN LOGIN');",
							"console.log('='.repeat(60));",
							"",
							"pm.test(\"âœ… Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"âœ… JWT token received\", function () {",
							"    var jsonData = pm.response.json();",
							"    console.log('ğŸ“Š Admin Login Response Keys:', Object.keys(jsonData));",
							"    ",
							"    // Response Ã¨ diretto: {jwt, refreshToken, user}",
							"    pm.expect(jsonData).to.have.property('jwt');",
							"    pm.expect(jsonData).to.have.property('refreshToken');",
							"    ",
							"    // Store admin token",
							"    pm.environment.set('adminTokenV2', jsonData.jwt);",
							"    console.log('ğŸ’¾ Saved adminTokenV2:', jsonData.jwt.substring(0, 50) + '...');",
							"});",
							"",
							"pm.test(\"âœ… Admin user data returned\", function () {",
							"    var jsonData = pm.response.json();",
							"    pm.expect(jsonData).to.have.property('user');",
							"    pm.expect(jsonData.user).to.have.property('id');",
							"    ",
							"    // Save admin ID",
							"    pm.environment.set('adminIdV2', jsonData.user.id);",
							"    console.log('ğŸ’¾ Saved adminIdV2:', jsonData.user.id);",
							"    console.log('ğŸ‘¤ Admin:', jsonData.user.email);",
							"});",
							"",
							"console.log('\\nâœ¨ STEP 1 COMPLETED: Admin logged in');",
							"console.log('Next: Proceed to STEP 2 - Get Restaurant User by Email');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"username\": \"{{adminEmail}}\",\n    \"password\": \"{{adminPassword}}\",\n    \"rememberMe\": true\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/admin/auth/login",
					"host": ["{{baseUrl}}"],
					"path": ["admin", "auth", "login"]
				}
			},
			"description": "ğŸ” **Step 1: Admin Login**\n\n- Login con le credenziali admin dall'environment\n- Estrae e salva il token JWT\n- Salva l'admin ID\n\n**Status**: 200 OK"
		},
		{
			"name": "Step 2: Get Restaurant User by Email (test@test.it)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"var token = pm.environment.get('adminTokenV2');",
							"console.log('ğŸ” Token available: ' + !!token);",
							"if (token) {",
							"    console.log('Token value: ' + token.substring(0, 50) + '...');",
							"} else {",
							"    console.log('âš ï¸ MISSING TOKEN');",
							"}"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// === STEP 2: GET RESTAURANT USER BY EMAIL ===",
							"console.log('\\nğŸ“‹ STEP 2: GET RESTAURANT USER BY EMAIL');",
							"console.log('='.repeat(60));",
							"",
							"pm.test(\"âœ… Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"âœ… Restaurant user found with email test@test.it\", function () {",
							"    var jsonData = pm.response.json();",
							"    console.log('ğŸ“Š User Response:', JSON.stringify(jsonData, null, 2));",
							"    ",
							"    // Response Ã¨ diretto: {id, username, restaurantId}",
							"    pm.expect(jsonData).to.have.property('id');",
							"    pm.expect(jsonData).to.have.property('username');",
							"    pm.expect(jsonData).to.have.property('restaurantId');",
							"});",
							"",
							"pm.test(\"âœ… Store Restaurant User ID and Restaurant ID\", function () {",
							"    var jsonData = pm.response.json();",
							"    ",
							"    pm.environment.set('rUserIdV2', jsonData.id);",
							"    pm.environment.set('restaurantIdV2', jsonData.restaurantId);",
							"    ",
							"    console.log('ğŸ’¾ Saved rUserIdV2:', jsonData.id);",
							"    console.log('ğŸ’¾ Saved restaurantIdV2:', jsonData.restaurantId);",
							"    console.log('ğŸ“§ User email:', jsonData.username);",
							"});",
							"",
							"console.log('\\nâœ¨ STEP 2 COMPLETED: Found restaurant user');",
							"console.log('Next: Proceed to STEP 3 - Enable Restaurant User');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Authorization",
						"value": "Bearer {{adminTokenV2}}"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/admin/restaurant/user/by-email/test@test.it",
					"host": ["{{baseUrl}}"],
					"path": ["admin", "restaurant", "user", "by-email", "test@test.it"]
				}
			},
			"description": "ğŸ” **Step 2: Get Restaurant User by Email**\n\n- Ricerca l'utente ristorante con email `test@test.it`\n- Salva il `rUserIdV2` per l'abilitazione\n- Salva il `restaurantIdV2` del ristorante\n\n**Status**: 200 OK"
		},
		{
			"name": "Step 3: Enable Restaurant User (test@test.it)",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"var token = pm.environment.get('adminTokenV2');",
							"var rUserId = pm.environment.get('rUserIdV2');",
							"console.log('ğŸ” Token available: ' + !!token);",
							"console.log('RUserId available: ' + !!rUserId);"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// === STEP 3: ENABLE RESTAURANT USER ===",
							"console.log('\\nğŸ“‹ STEP 3: ENABLE RESTAURANT USER');",
							"console.log('='.repeat(60));",
							"",
							"pm.test(\"âœ… Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"âœ… Restaurant user enabled successfully\", function () {",
							"    var jsonData = pm.response.json();",
							"    console.log('ğŸ“Š Enable Response:', JSON.stringify(jsonData, null, 2));",
							"    ",
							"    // Verify response structure",
							"    if (jsonData.message) {",
							"        console.log('âœ… Message:', jsonData.message);",
							"    }",
							"    if (jsonData.success) {",
							"        pm.expect(jsonData.success).to.eql(true);",
							"    }",
							"});",
							"",
							"console.log('\\nâœ¨ STEP 3 COMPLETED: Restaurant User enabled');",
							"console.log('Next: Proceed to STEP 4 - Enable Restaurant');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{adminTokenV2}}"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/admin/restaurant/user/enable?email=test@test.it",
					"host": ["{{baseUrl}}"],
					"path": ["admin", "restaurant", "user", "enable"],
					"query": [
						{
							"key": "email",
							"value": "test@test.it"
						}
					]
				}
			},
			"description": "âœ… **Step 3: Enable Restaurant User**\n\n- Abilita l'utente ristorante con email `test@test.it`\n- L'admin autorizza l'accesso del gestore del ristorante\n\n**Status**: 200 OK"
		},
		{
			"name": "Step 4: Enable Restaurant",
			"event": [
				{
					"listen": "prerequest",
					"script": {
						"exec": [
							"var token = pm.environment.get('adminTokenV2');",
							"var restaurantId = pm.environment.get('restaurantIdV2');",
							"var baseUrl = pm.environment.get('baseUrl');",
							"console.log('ğŸ” Token available: ' + !!token);",
							"console.log('RestaurantId available: ' + !!restaurantId);",
							"if (baseUrl && restaurantId) {",
							"    var url = baseUrl + '/admin/restaurant/' + restaurantId + '/enable_restaurant';",
							"    console.log('URL will be: ' + url);",
							"}"
						],
						"type": "text/javascript"
					}
				},
				{
					"listen": "test",
					"script": {
						"exec": [
							"// === STEP 4: ENABLE RESTAURANT ===",
							"console.log('\\nğŸ“‹ STEP 4: ENABLE RESTAURANT');",
							"console.log('='.repeat(60));",
							"",
							"pm.test(\"âœ… Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"âœ… Restaurant enabled successfully\", function () {",
							"    var jsonData = pm.response.json();",
							"    console.log('ğŸ“Š Enable Restaurant Response:', JSON.stringify(jsonData, null, 2));",
							"    ",
							"    // Verify response",
							"    if (jsonData.message) {",
							"        console.log('âœ… Message:', jsonData.message);",
							"    }",
							"    if (jsonData.success) {",
							"        pm.expect(jsonData.success).to.eql(true);",
							"    }",
							"});",
							"",
							"console.log('\\nâœ¨ STEP 4 COMPLETED: Restaurant enabled');",
							"console.log('Next: Proceed to STEP 5 - Verify Restaurant User Login');"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "PUT",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					},
					{
						"key": "Authorization",
						"value": "Bearer {{adminTokenV2}}"
					}
				],
				"url": {
					"raw": "{{baseUrl}}/admin/restaurant/{{restaurantIdV2}}/enable_restaurant",
					"host": ["{{baseUrl}}"],
					"path": ["admin", "restaurant", "{{restaurantIdV2}}", "enable_restaurant"]
				}
			},
			"description": "âœ… **Step 4: Enable Restaurant**\n\n- L'admin abilita il ristorante con ID `{{restaurantIdV2}}`\n- Rende il ristorante visibile e operativo nel sistema\n\n**Status**: 200 OK"
		},
		{
			"name": "Step 5: Restaurant User Login (Verification)",
			"event": [
				{
					"listen": "test",
					"script": {
						"exec": [
							"// === STEP 5: RESTAURANT USER LOGIN (VERIFICATION) ===",
							"console.log('\\nğŸ“‹ STEP 5: RESTAURANT USER LOGIN - VERIFICATION');",
							"console.log('='.repeat(60));",
							"",
							"pm.test(\"âœ… Status code is 200\", function () {",
							"    pm.response.to.have.status(200);",
							"});",
							"",
							"pm.test(\"âœ… JWT token received for restaurant user\", function () {",
							"    var jsonData = pm.response.json();",
							"    console.log('ğŸ“Š Login Response Keys:', Object.keys(jsonData));",
							"    ",
							"    // Response Ã¨ diretto: {jwt, refreshToken, user} oppure {accessToken, refreshToken, user}",
							"    var token = jsonData.jwt || jsonData.accessToken;",
							"    pm.expect(token).to.not.be.undefined;",
							"    ",
							"    pm.environment.set('restaurantTokenV2', token);",
							"    console.log('ğŸ’¾ Saved restaurantTokenV2:', token.substring(0, 50) + '...');",
							"});",
							"",
							"pm.test(\"âœ… User and restaurant info returned\", function () {",
							"    var jsonData = pm.response.json();",
							"    if (jsonData.user) {",
							"        console.log('ğŸ‘¤ User:', jsonData.user.username || jsonData.user.email);",
							"        console.log('ğŸª Restaurant ID:', jsonData.user.restaurantId);",
							"    }",
							"});",
							"",
							"console.log('\\nğŸ‰ COMPLETE: Restaurant Enablement Flow Successful!');",
							"console.log('â•'.repeat(60));",
							"console.log('âœ… Admin ha abilitato l\\'utente ristorante (test@test.it)');",
							"console.log('âœ… Admin ha abilitato il ristorante');",
							"console.log('âœ… Utente ristorante puÃ² ora fare login');",
							"console.log('â•'.repeat(60));"
						],
						"type": "text/javascript"
					}
				}
			],
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\n    \"username\": \"test@test.it\",\n    \"password\": \"TestPass123!\",\n    \"rememberMe\": true\n}"
				},
				"url": {
					"raw": "{{baseUrl}}/restaurant/user/auth/login",
					"host": ["{{baseUrl}}"],
					"path": ["restaurant", "user", "auth", "login"]
				}
			},
			"description": "ğŸ” **Step 5: Restaurant User Login (Verification)**\n\n- Verifica che l'utente ristorante puÃ² fare login\n- Conferma che il flusso di abilitazione Ã¨ completo\n\n**Credenziali:**\n- Email: `test@test.it`\n- Password: `TestPass123!`\n\n**Status**: 200 OK"
		}
	],
	"event": [
		{
			"listen": "prerequest",
			"script": {
				"type": "text/javascript",
				"exec": [
					"// Pre-request validation",
					"const authHeader = pm.request.headers.get('Authorization');",
					"if (authHeader && authHeader.includes('Bearer')) {",
					"    console.log('ğŸ” Authenticated request');",
					"}"
				]
			}
		}
	]
}
