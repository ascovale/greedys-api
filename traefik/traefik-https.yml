# ============================================================
# TRAEFIK v3.0 - Reverse Proxy + SSL/TLS Configuration
# ============================================================
# Documentation: https://doc.traefik.io/traefik/

global:
  checkNewVersion: true
  sendAnonymousUsage: false

# ============================================================
# API & DASHBOARD
# ============================================================
api:
  insecure: false  # Disabilita accesso insicuro (porta 8080)
  debug: false
  dashboard: true

# ============================================================
# ENTRY POINTS (Listener Ports)
# ============================================================
entryPoints:
  # HTTP - Reindirizza a HTTPS
  web:
    address: ":80"
    http:
      redirections:
        entryPoint:
          to: websecure
          scheme: https
          permanent: true  # HTTP 301 redirect

  # HTTPS - SSL/TLS
  websecure:
    address: ":443"
    http:
      tls:
        # Certificato di default per domini non configurati
        options: default
        certResolver: letsencrypt
        domains:
          - main: "greedys.it"
            sans:
              - "*.greedys.it"
              - "api.greedys.it"

# ============================================================
# PROVIDERS (Fonti di configurazione)
# ============================================================
providers:
  # Docker - Legge etichette dai container
  docker:
    endpoint: "unix:///var/run/docker.sock"
    exposedByDefault: false  # Solo container con traefik.enable=true
    network: traefik
    swarmMode: false
    watch: true
    
  # File dinamico - Configurazione YAML
  file:
    filename: /dynamic.yml
    watch: true

# ============================================================
# CERTIFICATE RESOLVERS (Let's Encrypt)
# ============================================================
certificatesResolvers:
  letsencrypt:
    acme:
      email: "beeinggreedy@gmail.com"  # Email per notifiche Let's Encrypt
      storage: "/acme.json"             # File di persistenza certificati
      
      # HTTP Challenge (consigliato per semplicit√†)
      httpChallenge:
        entryPoint: web  # Challenge su porta 80
      
      # Per wildcard (* domains), abilita DNS challenge:
      # dnsChallenge:
      #   provider: cloudflare
      #   delayBeforeCheck: 0
      #   resolvers:
      #     - "1.1.1.1:53"
      #     - "8.8.8.8:53"

# ============================================================
# LOGGING
# ============================================================
log:
  level: INFO
  format: json

accessLog:
  format: json
  filePath: "/var/log/traefik/access.log"
  fields:
    defaultMode: keep
    names:
      ClientUsername: drop
    headers:
      defaultMode: keep
      names:
        Authorization: drop
        Content-Type: keep
        User-Agent: drop

# ============================================================
# METRICS (Prometheus)
# ============================================================
metrics:
  prometheus:
    addEntryPointsLabels: true
    addServicesLabels: true
    addRoutersLabels: true
    buckets:
      - 0.005
      - 0.01
      - 0.025
      - 0.05
      - 0.1
      - 0.25
      - 0.5
      - 0.75
      - 1.0
      - 2.5
      - 5.0
      - 7.5
      - 10.0

# ============================================================
# TRACING (Optional - per debug)
# ============================================================
# tracing:
#   jaeger:
#     samplingServerURL: "http://jaeger:6831"
#     localAgentHostPort: "jaeger:6831"

