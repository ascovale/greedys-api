# ============================================================
# TRAEFIK Dynamic Configuration (YAML)
# ============================================================
# Middleware, Security Headers, Rate Limiting, TLS Options

http:
  # ============================================================
  # MIDDLEWARE DEFINITIONS
  # ============================================================
  middlewares:
    # CORS Middleware
    cors:
      headers:
        accessControlAllowMethods:
          - GET
          - POST
          - PUT
          - DELETE
          - OPTIONS
          - PATCH
          - HEAD
        accessControlAllowOriginList:
          - "https://greedys.it"
          - "https://www.greedys.it"
          - "https://app.greedys.it"
          - "http://localhost:3000"  # Development
          - "http://localhost:8081"  # Development
        accessControlAllowHeaders:
          - "Content-Type"
          - "Authorization"
          - "Accept"
          - "Accept-Language"
          - "X-Requested-With"
        accessControlExposeHeaders:
          - "Content-Length"
          - "Content-Type"
          - "Authorization"
          - "X-Total-Count"
          - "X-Page-Number"
        accessControlAllowCredentials: true
        accessControlMaxAge: 86400  # 24h

    # Security Headers Middleware
    security:
      headers:
        # HTTPS/SSL
        sslRedirect: true
        sslHost: "api.greedys.it"
        sslForceHost: true
        sslProxyHeaders:
          X-Forwarded-Proto: "https"
        
        # CSP - Content Security Policy
        contentSecurityPolicy: "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:;"
        
        # XSS Protection
        browserXssFilter: true
        
        # Clickjacking Prevention
        frameDeny: true
        
        # Content Type Sniffing
        contentTypeNosniff: true
        
        # HSTS - HTTP Strict Transport Security
        forceSTSHeader: true
        stsIncludeSubdomains: true
        stsPreload: true
        stsSeconds: 31536000  # 1 year
        
        # Custom Headers
        customRequestHeaders:
          X-Forwarded-Proto: "https"
          X-Forwarded-Host: "api.greedys.it"
          X-Forwarded-Port: "443"
        
        customResponseHeaders:
          X-Content-Type-Options: "nosniff"
          X-Frame-Options: "DENY"
          X-XSS-Protection: "1; mode=block"
          Referrer-Policy: "strict-origin-when-cross-origin"
          Permissions-Policy: "geolocation=(), microphone=(), camera=()"

    # Rate Limiting Middleware
    rate-limit:
      rateLimit:
        average: 100     # Richieste al secondo
        burst: 200       # Burst massimo
        period: 1m       # Periodo

    # Compression Middleware
    compression:
      compress: 
        minResponseBodyBytes: 1000
        excludedContentTypes:
          - text/event-stream

    # Request Timeout
    timeout:
      requestTimeout: 30s

    # Basic Auth per Dashboard (genera con: htpasswd -nb admin password)
    admin-auth:
      basicAuth:
        users:
          - "admin:$2y$10$X7.lMK/Q6.JLVQ5D8lHX3eoD5Y4iN1Q5V5N5N1N1N1N1N1N1N1N1N"  # Cambia questo!

  # ============================================================
  # ROUTERS (definiti da docker labels)
  # ============================================================
  # I routers sono automaticamente registrati via docker labels
  # delle applicazioni nel docker-compose.yml

  # ============================================================
  # SERVICES (definiti da docker labels)
  # ============================================================
  # I services sono automaticamente registrati via docker labels
  # delle applicazioni nel docker-compose.yml

# ============================================================
# TLS CONFIGURATION
# ============================================================
tls:
  # Certificati automatici (Let's Encrypt)
  # Gestiti da ACME nel traefik.yml
  
  # Certificati di fallback (self-signed)
  certificates:
    - certFile: /certs/localhost.crt
      keyFile: /certs/localhost.key

  # Store di certificati di default
  stores:
    default:
      defaultCertificate:
        certFile: /certs/localhost.crt
        keyFile: /certs/localhost.key

  # Opzioni TLS globali
  options:
    default:
      minVersion: "VersionTLS12"
      maxVersion: "VersionTLS13"
      sslProtocols:
        - "TLSv1.2"
        - "TLSv1.3"
      cipherSuites:
        # Modern (TLS 1.3)
        - "TLS_AES_256_GCM_SHA384"
        - "TLS_CHACHA20_POLY1305_SHA256"
        - "TLS_AES_128_GCM_SHA256"
        # Intermediate (TLS 1.2)
        - "TLS_ECDHE_ECDSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_RSA_WITH_AES_256_GCM_SHA384"
        - "TLS_ECDHE_ECDSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_RSA_WITH_CHACHA20_POLY1305"
        - "TLS_ECDHE_ECDSA_WITH_AES_128_GCM_SHA256"
        - "TLS_ECDHE_RSA_WITH_AES_128_GCM_SHA256"
      curvePreferences:
        - "CurveP521"
        - "CurveP384"
        - "CurveP256"

    # Strict TLS (se necessario per High Security)
    strict:
      minVersion: "VersionTLS13"
      maxVersion: "VersionTLS13"
      sslProtocols:
        - "TLSv1.3"
      cipherSuites:
        - "TLS_AES_256_GCM_SHA384"
        - "TLS_CHACHA20_POLY1305_SHA256"
        - "TLS_AES_128_GCM_SHA256"

